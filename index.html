<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insight Action Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for a better look in dark mode */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        #characterPanel {
            max-height: 85vh; /* 85% of the viewport height */
            overflow-y: auto; /* Add a scrollbar only when needed */
        }
        /* Style for the tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: max-content;
            background-color: #111827;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid #374151;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        /* Simple transition for expanding rows */
        .action-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            display: none;
        }
        .action-row.expanded .action-details {
            max-height: 200px; /* Adjust as needed */
            display: block;
        }
        .action-row.selected {
            border-color: #2563eb; /* A distinct blue border */
            border-width: 2px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans antialiased">

    <div id="app" class="container mx-auto p-4 md:p-6 lg:p-8">

        <header class="mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-4">Insight Action Analyzer</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <input type="text" id="searchInput" placeholder="Search for an action... (e.g., 'sneak', 'intimidate')" class="lg:col-span-2 w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="grid grid-cols-2 md:grid-cols-2 gap-4">
                    <div class="flex items-center">
                         <label for="sortOrder" class="text-sm mr-2">Sort:</label>
                        <select id="sortOrder" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-2 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="best">Best for Me</option>
                            <option value="alpha">Alphabetical</option>
                            <option value="page">Page Number</option>
                        </select>
                    </div>
                    <button id="toggleCharacterPanel" title="Toggle Character Panel" class="flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded-lg p-2 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <main id="mainContainer" class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Column: Character Sheet -->
            <aside id="characterPanel" class="lg:col-span-1 bg-gray-800 p-4 rounded-lg h-fit sticky top-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">My Character</h2>
                    <button id="resetCharacterBtn" class="text-sm text-blue-400 hover:text-blue-300 hover:underline">Reset</button>
                </div>
                <div id="characterSheet">
                    <!-- Character sheet will be dynamically generated here -->
                </div>
            </aside>

            <!-- Right Column: Action List -->
            <section id="actionListPanel" class="lg:col-span-2">
                <div id="actionList" class="space-y-3">
                    <!-- Action items will be dynamically generated here -->
                </div>
            </section>

        </main>
    </div>

    <script>
        // --- DATA ---
        // This section contains all the game data needed for the app.

        const actionsData = [
            { "Action": "Acrobatics Roll", "Page": 100, "Main Skill": "Agility (BC)", "Bonus Skill": "Balance (BC)", "Notes": "" },
            { "Action": "Animal Training", "Page": 100, "Main Skill": "Convince (SO)", "Bonus Skill": "Creature Insight (RE)", "Notes": "vs. Willpower (Morale + Courage) *" },
            { "Action": "Appraise", "Page": 100, "Main Skill": "Idea (RE)", "Bonus Skill": "any relevant Item Knowledge (KN)", "Notes": "" },
            { "Action": "Appraise, Hunch", "Page": 101, "Main Skill": "Idea (RE)", "Bonus Skill": "Item Insight (RE)", "Notes": "" },
            { "Action": "Armor Use", "Page": 101, "Main Skill": "Mobility (BC)", "Bonus Skill": "Flexibility (PF)", "Notes": "" },
            { "Action": "Autopsy", "Page": 108, "Main Skill": "Idea (RE)", "Bonus Skill": "Anatomy (KN)", "Notes": "" },
            { "Action": "Balance Roll", "Page": 108, "Main Skill": "Balance (BC)", "Bonus Skill": "Flexibility (PF)", "Notes": "" },
            { "Action": "Blend In", "Page": 108, "Main Skill": "Perform (SO)", "Bonus Skill": "Talk (SO)", "Notes": "" },
            { "Action": "Bluff", "Page": 109, "Main Skill": "Convince (SO)", "Bonus Skill": "Perform (SO)", "Notes": "vs. Sense Motive." },
            { "Action": "Breath Holding", "Page": 110, "Main Skill": "Endurance (PF)", "Bonus Skill": "Calmness (PF)", "Notes": "" },
            { "Action": "Butchering", "Page": 110, "Main Skill": "Crafting (BC)", "Bonus Skill": "Any Melee Weapons Knowledge (KN)", "Notes": "" },
            { "Action": "Camouflage Roll, Disguise", "Page": 110, "Main Skill": "Camouflage (BC special)", "Bonus Skill": "Perform (SO)", "Notes": "" },
            { "Action": "Camouflage Roll, Cloaking", "Page": 110, "Main Skill": "Camouflage (BC special)", "Bonus Skill": "Calmness (SO)", "Notes": "" },
            { "Action": "Cant", "Page": 110, "Main Skill": "Talk (SO)", "Bonus Skill": "Code Insight (SO)", "Notes": "(hidden communication)" },
            { "Action": "Climb Roll", "Page": 110, "Main Skill": "Mobility (BC)", "Bonus Skill": "Balance (BC)", "Notes": "" },
            { "Action": "Code Breaking", "Page": 111, "Main Skill": "Code Insight (RE)", "Bonus Skill": "Idea (RE)", "Notes": "" },
            { "Action": "Conceal, on Body", "Page": 111, "Main Skill": "Dexterity (BC)", "Bonus Skill": "Mobility (BC)", "Notes": "" },
            { "Action": "Conceal, in surroundings/tracks", "Page": 111, "Main Skill": "Dexterity (BC)", "Bonus Skill": "Perception (RE)", "Notes": "" },
            { "Action": "Cooking", "Page": 112, "Main Skill": "Crafting (BC)", "Bonus Skill": "Food (KN)", "Notes": "" },
            { "Action": "Crafting, Alchemy", "Page": 112, "Main Skill": "Crafting (BC)", "Bonus Skill": "Alchemy (KN)", "Notes": "" },
            { "Action": "Crafting, Item", "Page": 112, "Main Skill": "Crafting (BC)", "Bonus Skill": "any Item Knowledge (KN)", "Notes": "" },
            { "Action": "Crafting, Magic Item", "Page": 113, "Main Skill": "Crafting (BC)", "Bonus Skill": "any Magic (KN) Skill", "Notes": "REQ. Magic Focus (RE);" },
            { "Action": "Crafting, Poison", "Page": 114, "Main Skill": "Crafting (BC)", "Bonus Skill": "Poisons (KN)", "Notes": "" },
            { "Action": "Crafting, Scroll", "Page": 115, "Main Skill": "Crafting (BC)", "Bonus Skill": "any Magic (KN) Skill", "Notes": "" },
            { "Action": "Crafting, Weapon", "Page": 116, "Main Skill": "Crafting (BC)", "Bonus Skill": "Melee Weapons Knowledge (KN)", "Notes": "" },
            { "Action": "Crafting, Metal Armor", "Page": 116, "Main Skill": "Crafting (BC)", "Bonus Skill": "Metal Items Knowledge (KN)", "Notes": "" },
            { "Action": "Crafting, Non-metal Armor", "Page": 116, "Main Skill": "Crafting (BC)", "Bonus Skill": "Cloth Items Knowledge (KN)", "Notes": "" },
            { "Action": "Daunt Roll", "Page": 116, "Main Skill": "Daunt (ST)", "Bonus Skill": "Talk (SO)", "Notes": "vs. Complexity Level (Influence + Self-Insight Roll)" },
            { "Action": "Detect Magic Roll", "Page": 118, "Main Skill": "Perception (RE)", "Bonus Skill": "Code Insight (RE)", "Notes": "" },
            { "Action": "Detect Poison", "Page": 119, "Main Skill": "Perception (RE)", "Bonus Skill": "Poisons (KN)", "Notes": "" },
            { "Action": "Disable Device/Repair Device", "Page": 119, "Main Skill": "Dexterity (BC)", "Bonus Skill": "Mechanical Devices (KN)", "Notes": "" },
            { "Action": "Divine Chanting", "Page": 119, "Main Skill": "Divine Insight (RE)", "Bonus Skill": "any Rite (KN)", "Notes": "" },
            { "Action": "Dodge Roll", "Page": 119, "Main Skill": "Agility (BC)", "Bonus Skill": "Reaction (RE)", "Notes": "" },
            { "Action": "Dodge Roll, Quick", "Page": 119, "Main Skill": "Quick Dodge (BC special)", "Bonus Skill": "Reaction (RE)", "Notes": "" },
            { "Action": "Emotion Control", "Page": 120, "Main Skill": "Perform (SO)", "Bonus Skill": "Will (RE)", "Notes": "" },
            { "Action": "Empathy Roll", "Page": 120, "Main Skill": "Empathy (SO)", "Bonus Skill": "Comprehend (RE)", "Notes": "" },
            { "Action": "Endurance Roll", "Page": 120, "Main Skill": "Endurance (PF)", "Bonus Skill": "Will (RE)", "Notes": "" },
            { "Action": "Escape Artist", "Page": 120, "Main Skill": "Flexibility (PF)", "Bonus Skill": "Dexterity (BC)", "Notes": "" },
            { "Action": "Fall Roll/Falling", "Page": 120, "Main Skill": "Reaction (RE)", "Bonus Skill": "Flexibility (PF)", "Notes": "" },
            { "Action": "Fascinate", "Page": 121, "Main Skill": "Talk (SO)", "Bonus Skill": "Relevant Knowledge (KN) Skill", "Notes": "vs. Idea (RE) + the same Knowledge (KN) Skill." },
            { "Action": "Fire Building", "Page": 122, "Main Skill": "Crafting (BC)", "Bonus Skill": "Any Wood, Item (KN)", "Notes": "" },
            { "Action": "First Aid", "Page": 122, "Main Skill": "Medical (KN)", "Bonus Skill": "Anatomy (KN)", "Notes": "" },
            { "Action": "First Aid, Poison", "Page": 122, "Main Skill": "Medical (KN)", "Bonus Skill": "Poisons (KN)", "Notes": "" },
            { "Action": "Forage (Option 1)", "Page": 122, "Main Skill": "Nature (KN)", "Bonus Skill": "Perception (RE)", "Notes": "" },
            { "Action": "Forage (Option 2)", "Page": 122, "Main Skill": "Food (KN)", "Bonus Skill": "Perception (RE)", "Notes": "" },
            { "Action": "Health Roll (Option 1)", "Page": 123, "Main Skill": "Constitution (PF)", "Bonus Skill": "Will (RE)", "Notes": "" },
            { "Action": "Health Roll (Option 2)", "Page": 123, "Main Skill": "Toughness (ST)", "Bonus Skill": "Will (RE)", "Notes": "" },
            { "Action": "Hypnotism Roll", "Page": 123, "Main Skill": "Hypnosis (RE special)", "Bonus Skill": "Comprehend (RE)", "Notes": "vs. Willpower Roll." },
            { "Action": "Information Gathering, Analytic", "Page": 123, "Main Skill": "Idea (RE)", "Bonus Skill": "Code Insight (RE)", "Notes": "" },
            { "Action": "Information Gathering, Public", "Page": 123, "Main Skill": "Idea (RE)", "Bonus Skill": "Public (KN)", "Notes": "" },
            { "Action": "Information Gathering, Law", "Page": 124, "Main Skill": "Idea (RE)", "Bonus Skill": "Law (KN)", "Notes": "" },
            { "Action": "Interpreter Roll", "Page": 125, "Main Skill": "Talk (SO)", "Bonus Skill": "Interpreter (KN special)", "Notes": "" },
            { "Action": "Interrogation", "Page": 125, "Main Skill": "Talk (SO)", "Bonus Skill": "Perception (RE)", "Notes": "vs. Willpower." },
            { "Action": "Intimidation", "Page": 125, "Main Skill": "Convince (SO)", "Bonus Skill": "Brawn (ST)", "Notes": "vs. Willpower (reduce by Daunt Roll)." },
            { "Action": "Intuition Roll", "Page": 126, "Main Skill": "Intuition (RE)", "Bonus Skill": "Introspection (RE)", "Notes": "" },
            { "Action": "Jump", "Page": 126, "Main Skill": "Mobility (BC)", "Bonus Skill": "Flexibility (PF)", "Notes": "" },
            { "Action": "Law Roll", "Page": 126, "Main Skill": "Convince (SO)", "Bonus Skill": "Law (KN)", "Notes": "" },
            { "Action": "Leadership Roll", "Page": 126, "Main Skill": "Leadership (SO)", "Bonus Skill": "Talk (SO)", "Notes": "" },
            { "Action": "Lock Picking", "Page": 127, "Main Skill": "Dexterity (BC)", "Bonus Skill": "Mechanical Devices (KN)", "Notes": "" },
            { "Action": "Loyalty Roll", "Page": 127, "Main Skill": "Enhanced Leadership (SO special)", "Bonus Skill": "Motivate (SO special)", "Notes": "" },
            { "Action": "Magic Spell Casting", "Page": 128, "Main Skill": "Magic Insight (RE)", "Bonus Skill": "any Magic (KN) skill", "Notes": "Additional details on page 251." },
            { "Action": "Meditation Roll", "Page": 128, "Main Skill": "Serenity (RE)", "Bonus Skill": "Calmness (PF)", "Notes": "" },
            { "Action": "Morale Boost", "Page": 128, "Main Skill": "Motivate (SO special)", "Bonus Skill": "Motive Insight (RE)", "Notes": "" },
            { "Action": "Motivate/Demotivate", "Page": 129, "Main Skill": "Motivate (SO special)", "Bonus Skill": "Motive Insight (RE)", "Notes": "vs. Self-Insight Roll." },
            { "Action": "Navigation", "Page": 129, "Main Skill": "Idea (RE)", "Bonus Skill": "Nature (KN)", "Notes": "" },
            { "Action": "Negotiation", "Page": 129, "Main Skill": "Convince (SO)", "Bonus Skill": "Idea (RE)", "Notes": "" },
            { "Action": "Observation", "Page": 130, "Main Skill": "Creature Insight (RE)", "Bonus Skill": "Perception (RE)", "Notes": "" },
            { "Action": "Patience Roll", "Page": 130, "Main Skill": "Patience (SO)", "Bonus Skill": "Will (RE)", "Notes": "(Anger Management)" },
            { "Action": "Perception Roll, Active", "Page": 130, "Main Skill": "Perception (RE)", "Bonus Skill": "Sense (PF)", "Notes": "" },
            { "Action": "Perception Roll, Passive", "Page": 130, "Main Skill": "Sense (PF)", "Bonus Skill": "Perception (RE)", "Notes": "" },
            { "Action": "Perform, Instrumental", "Page": 131, "Main Skill": "Perform (SO)", "Bonus Skill": "any Music Instrument (KN) skill", "Notes": "" },
            { "Action": "Perform, Singing", "Page": 132, "Main Skill": "Perform (SO)", "Bonus Skill": "Singing (KN)", "Notes": "" },
            { "Action": "Persuasion", "Page": 132, "Main Skill": "Convince (SO)", "Bonus Skill": "Motive Insight (RE)", "Notes": "" },
            { "Action": "Pick Pockets", "Page": 133, "Main Skill": "Dexterity (BC)", "Bonus Skill": "Reaction (RE)", "Notes": "(stealing in general). vs. Passive Perception Roll" },
            { "Action": "Precision Roll", "Page": 133, "Main Skill": "Precision (BC)", "Bonus Skill": "Dexterity (BC)", "Notes": "" },
            { "Action": "Psychology", "Page": 133, "Main Skill": "Idea (RE)", "Bonus Skill": "Motive Insight (KN)", "Notes": "" },
            { "Action": "Reaction Roll", "Page": 133, "Main Skill": "Reaction (BC)", "Bonus Skill": "Perception (RE)", "Notes": "" },
            { "Action": "Recall Roll", "Page": 134, "Main Skill": "Recall (RE)", "Bonus Skill": "Idea (RE)", "Notes": "" },
            { "Action": "Recall Roll, Logic", "Page": 134, "Main Skill": "Logic Recall (RE special)", "Bonus Skill": "Idea (RE)", "Notes": "" },
            { "Action": "Resist Cold", "Page": 135, "Main Skill": "Toughness (ST)", "Bonus Skill": "Constitution (PF)", "Notes": "" },
            { "Action": "Resist Diseases", "Page": 135, "Main Skill": "Constitution (PF)", "Bonus Skill": "Endurance (PF)", "Notes": "" },
            { "Action": "Resist Fire", "Page": 135, "Main Skill": "Toughness (ST)", "Bonus Skill": "Constitution (PF)", "Notes": "" },
            { "Action": "Resist Magic (Option 1)", "Page": 135, "Main Skill": "Constitution (PF)", "Bonus Skill": "Reaction (RE)", "Notes": "" },
            { "Action": "Resist Magic (Option 2)", "Page": 135, "Main Skill": "Reaction (RE)", "Bonus Skill": "Constitution (PF)", "Notes": "" },
            { "Action": "Resist Nausea", "Page": 135, "Main Skill": "Constitution (PF)", "Bonus Skill": "Will (RE)", "Notes": "" },
            { "Action": "Resist Pain", "Page": 135, "Main Skill": "Constitution (PF)", "Bonus Skill": "Will (RE)", "Notes": "" },
            { "Action": "Resist Poison", "Page": 135, "Main Skill": "Constitution (PF)", "Bonus Skill": "Endurance (PF)", "Notes": "" },
            { "Action": "Riding Roll", "Page": 136, "Main Skill": "Balance (BC)", "Bonus Skill": "Mobility (BC)", "Notes": "" },
            { "Action": "Rope Use (Option 2)", "Page": 137, "Main Skill": "Dexterity (BC)", "Bonus Skill": "Brawn (ST)", "Notes": "with no Action Improvements." },
            { "Action": "Rope Use (Option 3)", "Page": 137, "Main Skill": "Dexterity (BC)", "Bonus Skill": "Flexibility (PF)", "Notes": "with no Action Improvements." },
            { "Action": "Rowing", "Page": 137, "Main Skill": "Brawn (ST)", "Bonus Skill": "Power (PF)", "Notes": "" },
            { "Action": "Self-Insight Roll", "Page": 137, "Main Skill": "Introspection (BC)", "Bonus Skill": "Comprehend (RE)", "Notes": "" },
            { "Action": "Seduce", "Page": 138, "Main Skill": "Talk (SO)", "Bonus Skill": "Appearance (PF)", "Notes": "" },
            { "Action": "Sense Intention (creature)", "Page": 138, "Main Skill": "Creature Insight (RE)", "Bonus Skill": "Comprehend (RE)", "Notes": "" },
            { "Action": "Sense Motive", "Page": 138, "Main Skill": "Motive Insight (RE)", "Bonus Skill": "Idea (RE)", "Notes": "vs. Bluff." },
            { "Action": "Sleight of Hand Roll", "Page": 139, "Main Skill": "Sleight of Hand (BC special)", "Bonus Skill": "Haste (PF)", "Notes": "" },
            { "Action": "Sneak Roll, Hide", "Page": 139, "Main Skill": "Agility (BC)", "Bonus Skill": "Mobility (BC)", "Notes": "vs. Perception Roll (active or passive)." },
            { "Action": "Sneak Roll, Exposed Hiding", "Page": 139, "Main Skill": "Agility (BC)", "Bonus Skill": "Flexibility (PF)", "Notes": "vs. Perception Roll (Active)." },
            { "Action": "Sneak Roll, Move Silent", "Page": 139, "Main Skill": "Agility (BC)", "Bonus Skill": "Mobility (BC)", "Notes": "vs. Perception Roll (active or passive)." },
            { "Action": "Sneak Roll, Move Silent & Hidden", "Page": 140, "Main Skill": "Agility (BC)", "Bonus Skill": "Mobility (BC)", "Notes": "vs. Perception Roll (active or passive)." },
            { "Action": "Strength Roll", "Page": 141, "Main Skill": "Brawn (ST)", "Bonus Skill": "Power (ST)", "Notes": "" },
            { "Action": "Study Roll (General)", "Page": 142, "Main Skill": "Study (RE special)", "Bonus Skill": "relevant knowledge (KN) skill", "Notes": "" },
            { "Action": "Study Roll (Weapons and Armor)", "Page": 142, "Main Skill": "Study (RE special)", "Bonus Skill": "relevant knowledge (KN) skill", "Notes": "" },
            { "Action": "Study Roll (Alchemy)", "Page": 142, "Main Skill": "Study (RE special)", "Bonus Skill": "Alchemy (KN)", "Notes": "" },
            { "Action": "Study Roll (People)", "Page": 142, "Main Skill": "Study (RE special)", "Bonus Skill": "Motive Insight (RE)", "Notes": "" },
            { "Action": "Study Roll (Sample)", "Page": 142, "Main Skill": "Study (RE special)", "Bonus Skill": "Nature (KN)", "Notes": "" },
            { "Action": "Surgery Roll", "Page": 143, "Main Skill": "Surgery (KN special)", "Bonus Skill": "Idea (RE)", "Notes": "" },
            { "Action": "Survival", "Page": 143, "Main Skill": "Idea (RE)", "Bonus Skill": "Nature (KN)", "Notes": "" },
            { "Action": "Swim Roll", "Page": 143, "Main Skill": "Swimming (BC)", "Bonus Skill": "Flexibility (PF)", "Notes": "" },
            { "Action": "Terrifying Gaze", "Page": 143, "Main Skill": "Terrifying Look (ST special)", "Bonus Skill": "Perform (SO)", "Notes": "" },
            { "Action": "Throw Roll", "Page": 143, "Main Skill": "Dexterity (BC)", "Bonus Skill": "Power (PF)", "Notes": "" },
            { "Action": "Torture", "Page": 144, "Main Skill": "Convince (SO)", "Bonus Skill": "Will (RE)", "Notes": "vs. Resist Pain." },
            { "Action": "Tracking", "Page": 144, "Main Skill": "Perception (RE)", "Bonus Skill": "Idea (RE)", "Notes": "" },
            { "Action": "Understand (General - Option 1)", "Page": 144, "Main Skill": "Idea (RE)", "Bonus Skill": "Comprehend (RE)", "Notes": "" },
            { "Action": "Understand (General - Option 2)", "Page": 144, "Main Skill": "Idea (RE)", "Bonus Skill": "Law (KN)", "Notes": "" },
            { "Action": "Understand (General - Option 3)", "Page": 144, "Main Skill": "Idea (RE)", "Bonus Skill": "Public (KN)", "Notes": "" },
            { "Action": "Understand (Objects - Option 1)", "Page": 145, "Main Skill": "Idea (RE)", "Bonus Skill": "relevant knowledge (KN) skill", "Notes": "" },
            { "Action": "Understand (Objects - Option 2)", "Page": 145, "Main Skill": "Idea (RE)", "Bonus Skill": "Item Insight (RE)", "Notes": "" },
            { "Action": "Understand (Text)", "Page": 145, "Main Skill": "Idea (RE)", "Bonus Skill": "Languages (KN)", "Notes": "" },
            { "Action": "Understand (Creature)", "Page": 145, "Main Skill": "Idea (RE)", "Bonus Skill": "Creature Insight (RE)", "Notes": "" },
            { "Action": "Understand (Riddles)", "Page": 145, "Main Skill": "Idea (RE)", "Bonus Skill": "Code Insight (RE)", "Notes": "" },
            { "Action": "Willpower Roll", "Page": 145, "Main Skill": "Will (RE)", "Bonus Skill": "Introspection (RE)", "Notes": "" },
            { "Action": "Attack, Standard Melee", "Page": 102, "Main Skill": "Any Melee (BC)", "Bonus Skill": "Melee Weapons Knowledge (KN)", "Notes": "vs. Defense Roll, Dodge Roll, or Block" },
            { "Action": "Attack, Standard Unarmed", "Page": 102, "Main Skill": "Unarmed (Small) Melee (BC)", "Bonus Skill": "Martial Arts (KN)", "Notes": "vs. Defense Roll, Dodge Roll, or Block" },
            { "Action": "Attack, Acrobatic (Step 1: Roll)", "Page": 102, "Main Skill": "Agility (BC)", "Bonus Skill": "Balance (BC)", "Notes": "REQ. Full Attack." },
            { "Action": "Attack, Bull Rush", "Page": 103, "Main Skill": "Unarmed Melee (BC)", "Bonus Skill": "Haste (PF)", "Notes": "REQ. Full Attack. vs. Defense Roll or Dodge Roll" },
            { "Action": "Attack, Charge", "Page": 103, "Main Skill": "Any Melee (BC)", "Bonus Skill": "Melee Weapons Knowledge (KN)", "Notes": "REQ. Full Attack, Start 5 tiles from target. vs. Defense Roll, Dodge Roll, or Block." },
            { "Action": "Attack, Grapple", "Page": 104, "Main Skill": "(Small &) Unarmed Melee (BC)", "Bonus Skill": "Dexterity (BC)", "Notes": "REQ. Full Attack. vs. Grapple Attack, Defense Roll, or Dodge Roll." },
            { "Action": "Attack, Mounted Archery (Step 1: Ride)", "Page": 105, "Main Skill": "Balance (BC)", "Bonus Skill": "Mobility (BC)", "Notes": "REQ. Quick or Aimed." },
            { "Action": "Attack, Ranged Bow", "Page": 105, "Main Skill": "Archery (BC)", "Bonus Skill": "Simple Ranged Weapon Knowledge (KN)", "Notes": "REQ. Quick or Aimed. vs. Defense Roll, Ranged." },
            { "Action": "Attack, Ranged Crossbow", "Page": 105, "Main Skill": "Crossbows (BC)", "Bonus Skill": "Mechanical Weapons Knowledge (KN)", "Notes": "REQ. Quick or Aimed. vs. Defense Roll, Ranged." },
            { "Action": "Attack, Ranged Slings", "Page": 106, "Main Skill": "Slings (BC)", "Bonus Skill": "Simple Ranged Weapons Knowledge (KN)", "Notes": "REQ. Quick or Aimed. vs. Defense Roll, Ranged." },
            { "Action": "Attack, Blowguns", "Page": 106, "Main Skill": "Blowguns (BC)", "Bonus Skill": "Blowguns Knowledge (KN)", "Notes": "REQ. Quick or Aimed. vs. Defense Roll, Ranged." },
            { "Action": "Attack, Sneak", "Page": 106, "Main Skill": "Any Melee (BC)", "Bonus Skill": "Melee Weapons Knowledge (KN)", "Notes": "REQ. Full Attack. vs. Defense Roll or Dodge Roll." },
            { "Action": "Attack, Taunt", "Page": 106, "Main Skill": "Any Melee (BC)", "Bonus Skill": "Talk (SO)", "Notes": "vs. Willpower Roll." },
            { "Action": "Attack, Thrown Weapon", "Page": 107, "Main Skill": "Any Melee (BC)", "Bonus Skill": "Melee Weapons Knowledge (KN)", "Notes": "REQ. Full Attack. vs. Defense Roll, Dodge Roll, or Block." },
            { "Action": "Attack, Trip (Unarmed)", "Page": 107, "Main Skill": "(Small &) Unarmed Melee (BC)", "Bonus Skill": "Martial Arts (KN)", "Notes": "REQ. Full Attack. vs. Defense Roll or Dodge Roll." },
            { "Action": "Attack, Trip (Armed)", "Page": 107, "Main Skill": "Med/Lrg Melee (BC)", "Bonus Skill": "Melee Weapons Knowledge (KN)", "Notes": "REQ. Full Attack. vs. Defense Roll or Dodge Roll." },
            { "Action": "Attack, Tumble", "Page": 107, "Main Skill": "Small & Unarmed Melee (BC)", "Bonus Skill": "Quick Dodge (BC special)", "Notes": "REQ. Full Attack." },
            { "Action": "Block, Arm Block", "Page": 109, "Main Skill": "Haste (PF)", "Bonus Skill": "Reaction (RE)", "Notes": "alternative to Standard Defense Roll." },
            { "Action": "Block, Unarmed Block", "Page": 109, "Main Skill": "Unarmed Master (BC special)", "Bonus Skill": "Ambidextrous (BC)", "Notes": "alternative to Standard Defense Roll." },
            { "Action": "Block, Shield Block", "Page": 109, "Main Skill": "Haste (PF)", "Bonus Skill": "Reaction (RE)", "Notes": "alternative to Standard Defense Roll." },
            { "Action": "Defense Roll, Ranged (Dodge - Step 1)", "Page": 117, "Main Skill": "Reaction (RE)", "Bonus Skill": "Perception (RE)", "Notes": "Dodge Projectiles." },
            { "Action": "Defense Roll, Ranged (Dodge - Step 2)", "Page": 117, "Main Skill": "Agility (BC)", "Bonus Skill": "Reaction (RE)", "Notes": "" },
            { "Action": "Defense Roll, Ranged (Block - Step 1)", "Page": 118, "Main Skill": "Reaction (RE)", "Bonus Skill": "Perception (RE)", "Notes": "Shield Block Projectiles." },
            { "Action": "Defense Roll, Ranged (Block - Step 2)", "Page": 118, "Main Skill": "Haste (PF)", "Bonus Skill": "Reaction (RE)", "Notes": "" },
            { "Action": "Initiative Adjust Roll", "Page": 124, "Main Skill": "Endurance (PF)", "Bonus Skill": "Will (RE)", "Notes": "" },
            { "Action": "Initiative Roll", "Page": 124, "Main Skill": "Any Combat Skill (BC)", "Bonus Skill": "Reaction (RE)", "Notes": "" }
        ];

        const specializedSkills = new Set([
            'Camouflage', 'Quick Dodge', 'Hypnosis', 'Interpreter', 'Enhanced Leadership',
            'Motivate', 'Logic Recall', 'Sleight of Hand', 'Study', 'Surgery',
            'Terrifying Look', 'Unarmed Master', 'Ambidextrous'
        ]);

        const characterSchema = {
            "Strength (ST)": ["Daunt", "Brawn", "Power", "Toughness", "Terrifying Look"],
            "Physical Fitness (PF)": ["Flexibility", "Calmness", "Endurance", "Haste", "Power", "Constitution", "Sense", "Appearance"],
            "Body Control (BC)": ["Agility", "Balance", "Crafting", "Dexterity", "Mobility", "Precision", "Reaction", "Swimming", "Any Melee", "Unarmed (Small) Melee", "Archery", "Crossbows", "Slings", "Blowguns", "Med/Lrg Melee", "Small & Unarmed Melee", "Introspection", "Any Combat Skill", "Sleight of Hand", "Quick Dodge", "Unarmed Master", "Ambidextrous", "Camouflage"],
            "Reason (RE)": ["Idea", "Code Insight", "Item Insight", "Creature Insight", "Anatomy", "Perception", "Divine Insight", "Reaction", "Comprehend", "Empathy", "Will", "Hypnosis", "Introspection", "Intuition", "Motive Insight", "Logic Recall", "Recall", "Serenity", "Study"],
            "Social (SO)": ["Convince", "Perform", "Talk", "Calmness", "Code Insight", "Empathy", "Leadership", "Patience", "Motivate", "Enhanced Leadership"],
            "Knowledge (KN)": ["Item Knowledge", "Anatomy", "Melee Weapons Knowledge", "Food", "Alchemy", "Magic", "Poisons", "Metal Items Knowledge", "Cloth Items Knowledge", "Mechanical Devices", "Rite", "Wood, Item", "Medical", "Nature", "Public", "Law", "Interpreter", "Music Instrument", "Singing", "Motive Insight", "Languages", "Surgery", "Martial Arts", "Simple Ranged Weapon", "Mechanical Weapons", "Blowguns Knowledge"]
        };

        // UPDATED: New success range table based on user feedback
        const successRangeTable = {
            0: 9, 1: 8, 2: 7, 3: 6
        };

        const synonymDictionary = {
            // --- Meta Categories ---
            'combat': ['attack', 'strike', 'fight', 'block', 'defend', 'dodge', 'parry', 'grapple', 'disarm', 'charge', 'rush', 'initiative', 'armor', 'arrow catching', 'counterattack'],

            // --- Social & Influence ---
            'talk': ['speak', 'convince', 'persuade', 'negotiate', 'bluff', 'lie', 'interrogate', 'taunt', 'cant', 'fascinate', 'seduce', 'intimidate', 'daunt', 'leadership', 'motivate', 'perform'],
            'persuade': ['convince', 'negotiate', 'bluff', 'fascinate', 'seduce', 'influence', 'talk'],
            'convince': ['persuade', 'negotiate', 'bluff', 'fascinate', 'seduce', 'influence', 'talk'],
            'negotiate': ['bargain', 'haggle', 'convince', 'persuade', 'talk'],
            'bluff': ['lie', 'deceive', 'mislead', 'trick', 'talk'],
            'lie': ['bluff', 'deceive', 'mislead', 'trick'],
            'intimidate': ['daunt', 'threaten', 'scare', 'frighten', 'terrify', 'torture'],
            'daunt': ['intimidate', 'threaten', 'scare', 'frighten', 'terrify'],
            'motivate': ['inspire', 'encourage', 'lead', 'boost morale', 'loyalty'],
            'lead': ['motivate', 'inspire', 'command', 'guide', 'leadership'],
            'perform': ['sing', 'play', 'act', 'dance', 'blend in'],

            // --- Stealth & Deception ---
            'stealth': ['sneak', 'hide', 'conceal', 'camouflage', 'disguise', 'move silent'],
            'sneak': ['stealth', 'hide', 'conceal', 'camouflage', 'disguise', 'move silent'],
            'hide': ['stealth', 'sneak', 'conceal', 'camouflage', 'disguise'],
            'conceal': ['stealth', 'sneak', 'hide', 'camouflage', 'disguise'],
            'disguise': ['camouflage', 'impersonate', 'hide', 'conceal'],
            'pickpocket': ['steal', 'pilfer', 'thieve', 'sleight of hand'],
            'steal': ['pickpocket', 'pilfer', 'thieve'],
            'lockpick': ['disable device', 'open lock'],

            // --- Combat & Physical Action ---
            'attack': ['strike', 'fight', 'assault', 'charge', 'rush', 'grapple', 'trip', 'tumble', 'hit', 'disarm', 'bull rush'],
            'strike': ['attack', 'fight', 'hit'],
            'fight': ['attack', 'strike', 'combat', 'brawl'],
            'block': ['defend', 'parry', 'resist', 'withstand', 'dodge', 'arrow catching'],
            'defend': ['block', 'parry', 'resist', 'withstand', 'dodge', 'guard'],
            'dodge': ['evade', 'avoid', 'block', 'defend', 'tumble'],
            'throw': ['hurl', 'toss', 'fling'],
            'jump': ['leap', 'bound', 'hop'],
            'climb': ['scale', 'ascend'],
            'swim': ['dive', 'wade'],

            // --- Perception & Investigation ---
            'search': ['find', 'spot', 'perceive', 'observe', 'track', 'detect', 'look', 'investigate', 'examine', 'scrutinize', 'appraise'],
            'find': ['search', 'spot', 'perceive', 'observe', 'track', 'detect', 'locate'],
            'observe': ['watch', 'see', 'spot', 'perceive', 'notice', 'search', 'sense'],
            'detect': ['find', 'notice', 'sense', 'perceive', 'search'],
            'track': ['follow', 'trail', 'hunt', 'pursue', 'survival'],
            'appraise': ['evaluate', 'value', 'assess', 'judge', 'price', 'examine'],
            'study': ['learn', 'research', 'examine', 'analyze', 'investigate', 'recall', 'understand'],
            'understand': ['comprehend', 'decipher', 'interpret', 'grasp', 'fathom', 'riddle', 'code breaking'],
            'recall': ['remember', 'recollect', 'know'],
            'sense': ['perceive', 'feel', 'detect', 'intuition', 'empathy', 'sense motive'],

            // --- Crafting & Creation ---
            'craft': ['make', 'build', 'create', 'repair', 'butcher', 'cook', 'forge', 'construct', 'alchemy', 'poison'],
            'make': ['craft', 'build', 'create', 'repair', 'construct'],
            'repair': ['fix', 'mend', 'restore', 'disable device'],
            'fix': ['repair', 'mend', 'restore'],
            'cook': ['butcher', 'prepare food'],

            // --- Endurance & Resistance ---
            'resist': ['endure', 'withstand', 'block', 'defend', 'survive', 'tolerate', 'health', 'willpower'],
            'endure': ['resist', 'withstand', 'survive', 'last', 'tolerate', 'breath holding'],
            'heal': ['first aid', 'medicine', 'surgery', 'restore'],

            // --- Magic & Supernatural ---
            'magic': ['spell', 'chant', 'ritual', 'divine', 'psionic', 'enchant', 'scroll'],
            'spell': ['magic', 'chant', 'ritual', 'incantation']
        };

        // --- APP STATE ---
        let characterData = {};
        let uiState = {
            expandedAction: null,
            selectedActionIndex: -1 // -1 means no action is selected
        };

        // --- UTILITY FUNCTIONS ---

        /**
         * Extracts the attribute code (e.g., 'BC') from a skill string.
         * This version correctly handles 'special' tags like (RE special).
         * @param {string} skill - The full skill string, e.g., "Agility (BC)" or "Study (RE special)".
         * @returns {string|null} The attribute code or null if not found.
         */
        function getAttributeFromSkill(skill) {
            // This regex looks for a two-letter uppercase code inside parentheses,
            // optionally followed by the word "special". It only captures the two-letter code.
            const match = skill.match(/\(([A-Z]{2})(?: special)?\)/);
            return match ? match[1] : null;
        }

        /**
         * Finds the full attribute name (e.g., "Body Control (BC)") from its abbreviation.
         * @param {string} abbr - The attribute abbreviation (e.g., "BC").
         * @returns {string|null} The full attribute name or null.
         */
        function getFullAttributeName(abbr) {
            if (!abbr) return null;
            for (const fullName in characterSchema) {
                if (getAttributeFromSkill(fullName) === abbr) {
                    return fullName;
                }
            }
            return null;
        }

        /**
         * Gets a value from the character data, defaulting to 0.
         * @param {string} key - The key for the data (e.g., "Agility" or "Body Control (BC)").
         * @returns {number} The stored value or 0.
         */
        function getCharValue(key) {
            return parseInt(characterData[key] || '0', 10);
        }

        // --- DOM & RENDERING ---
        const characterSheetEl = document.getElementById('characterSheet');
        const actionListEl = document.getElementById('actionList');
        const searchInputEl = document.getElementById('searchInput');
        const sortOrderEl = document.getElementById('sortOrder');

        /**
         * Generates the HTML for the character sheet based on the schema.
         */
        function renderCharacterSheet() {
            let html = '';
            for (const attribute in characterSchema) {
                html += `
                    <details class="bg-gray-700/50 rounded-lg mb-3">
                        <summary class="font-bold text-lg cursor-pointer p-3 flex justify-between items-center">
                            <span>${attribute}</span>
                            <div class="flex items-center" onclick="event.stopPropagation()">
                                <label class="text-sm font-semibold mr-2">Score:</label>
                                <input type="number" min="0" data-type="attribute" data-key="${attribute}" value="${getCharValue(attribute)}" class="w-16 bg-gray-800 border border-gray-600 rounded px-2 py-1">
                            </div>
                        </summary>
                        <div class="p-3 border-t border-gray-600">
                `;

                const sortedSkills = [...characterSchema[attribute]].sort();

                sortedSkills.forEach(skill => {
                    const isSpecial = specializedSkills.has(skill);
                    const skillDisplayName = isSpecial ? `${skill} (special)` : skill;

                    html += `
                        <div class="grid grid-cols-5 gap-2 items-center mb-1">
                            <label class="col-span-3 text-sm ${isSpecial ? 'text-blue-300' : ''}">${skillDisplayName}:</label>
                            <input type="number" min="0" data-type="skill" data-key="${skill}" value="${getCharValue(skill)}" class="col-span-2 bg-gray-800 border border-gray-600 rounded px-2 py-1">
                        </div>
                    `;
                });
                html += `</div></details>`;
            }
            characterSheetEl.innerHTML = html;
        }

        /**
         * Renders the entire list of actions based on current filters and sorting.
         */
        function renderActionList() {
            const searchTerm = searchInputEl.value.toLowerCase().trim();
            const sortBy = sortOrderEl.value;

            let searchTerms = [searchTerm];
            if (synonymDictionary[searchTerm]) {
                searchTerms = [searchTerm, ...synonymDictionary[searchTerm]];
            }

            const filteredActions = actionsData.filter(action => {
                if (!searchTerm) return true;
                const actionText = (action.Action + ' ' + action['Main Skill'] + ' ' + action['Bonus Skill']).toLowerCase();
                return searchTerms.some(term => actionText.includes(term));
            });

            const actionsWithMetrics = filteredActions.map(action => {
                const mainSkill = action['Main Skill'];
                const bonusSkill = action['Bonus Skill'];
                const mainSkillName = mainSkill.split(' (')[0];
                let bonusSkillName = bonusSkill.split(' (')[0];

                // NEW: Check for the "any relevant" case
                const isBonusSkillVariable = bonusSkill.toLowerCase().includes('any');
                if (isBonusSkillVariable) {
                    bonusSkillName = 'Relevant Knowledge'; // Set a clean name for display
                }

                const mainSkillAttrAbbr = getAttributeFromSkill(mainSkill);
                const fullMainSkillAttr = getFullAttributeName(mainSkillAttrAbbr);
                const primarySkillRank = getCharValue(mainSkillName);

                // MODIFIED: Use 0 if the bonus skill is variable, otherwise get the value
                const secondarySkillRank = isBonusSkillVariable ? 0 : getCharValue(bonusSkillName);

                const attributeScore = getCharValue(fullMainSkillAttr);
                const dicePool = attributeScore + secondarySkillRank;

                let successThreshold;
                if (primarySkillRank === 0 && mainSkillAttrAbbr === 'KN') {
                    successThreshold = 10;
                } else {
                    successThreshold = successRangeTable[primarySkillRank] || 11;
                }

                const singleDieSuccessChance = Math.max(0, (11 - successThreshold) / 10);
                const avgSuccesses = dicePool * singleDieSuccessChance;

                return {
                    ...action,
                    metrics: { dicePool, avgSuccesses, mainSkillName, bonusSkillName, fullMainSkillAttr, primarySkillRank, secondarySkillRank, attributeScore, successThreshold, isBonusSkillVariable }
                };
            });

            actionsWithMetrics.sort((a, b) => {
                switch (sortBy) {
                    case 'alpha': return a.Action.localeCompare(b.Action);
                    case 'page': return (a.Page || 999) - (b.Page || 999);
                    default: return b.metrics.avgSuccesses - a.metrics.avgSuccesses;
                }
            });

            if (actionsWithMetrics.length === 0) {
                actionListEl.innerHTML = `<div class="bg-gray-800 p-4 rounded-lg text-center">No actions found.</div>`;
                return;
            }

            actionListEl.innerHTML = actionsWithMetrics.map((action, index) => generateActionRowHTML(action, index)).join('');

            if (uiState.selectedActionIndex !== -1) {
                const selectedElement = document.getElementById(`action-row-${uiState.selectedActionIndex}`);
                if (selectedElement) {
                    selectedElement.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
            }
        }

        /**
         * Generates the HTML for a single action row.
         */
        function generateActionRowHTML(action, index) {
            const { metrics } = action;
            const isExpanded = uiState.expandedAction === action.Action;
            const isSelected = uiState.selectedActionIndex === index;

            const simplifiedMain = metrics.mainSkillName.replace(/\(.*\)/, '').trim();
            const simplifiedBonus = metrics.bonusSkillName.replace(/\(.*\)/, '').trim();

            // NEW: Add a star if the bonus skill is variable
            const bonusSkillDisplay = `${simplifiedBonus}${metrics.isBonusSkillVariable ? ' *' : ''}`;

            return `
                <div class="action-row bg-gray-800 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-700/80 ${isExpanded ? 'expanded' : ''} ${isSelected ? 'selected' : ''}" data-action-name="${action.Action}" id="action-row-${index}">
                    <div class="p-4">
                        <div class="grid grid-cols-2 gap-x-4">
                            <div>
                                <h3 class="font-bold text-lg text-white">${action.Action}</h3>
                                <div class="tooltip">
                                    <p class="text-sm text-gray-400">${simplifiedMain} + ${bonusSkillDisplay}</p>
                                    <span class="tooltiptext">${action['Main Skill']} + ${action['Bonus Skill']}${metrics.isBonusSkillVariable ? ' (Using Rank 0)' : ''}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-white">Dice Pool: ${metrics.dicePool}d10</p>
                                <p class="text-sm text-gray-400">
                                    Success: ${metrics.successThreshold}+ (Avg: ${metrics.avgSuccesses.toFixed(2)})
                                </p>
                            </div>
                        </div>
                        <div class="action-details mt-4 pt-4 border-t border-gray-700 text-sm">
                            <p><strong class="text-gray-300">Notes:</strong> ${action.Notes || 'None'}</p>
                            <p><strong class="text-gray-300">Page:</strong> ${action.Page || 'N/A'}</p>
                            <p class="mt-2 text-blue-300"><strong class="text-gray-300">Calculation:</strong>
                                ${metrics.attributeScore}d10 (from ${metrics.fullMainSkillAttr}) +
                                ${metrics.secondarySkillRank}d10 (from ${metrics.bonusSkillName})
                            </p>
                             <p class="text-blue-300"><strong class="text-gray-300">Success on:</strong>
                                ${metrics.successThreshold}+ (from ${metrics.mainSkillName} rank ${metrics.primarySkillRank})
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }


        // --- EVENT HANDLERS & INITIALIZATION ---

        /**
         * Handles input changes on the character sheet.
         * @param {Event} e - The input event.
         */
        function handleCharacterDataChange(e) {
            if (e.target.matches('input[type="number"]')) {
                const key = e.target.dataset.key;
                const value = e.target.value;
                characterData[key] = value;
                localStorage.setItem('insightCharacterData', JSON.stringify(characterData));
                renderActionList();
            }
        }

        /**
         * Handles clicks on the action list to expand/collapse rows.
         * @param {Event} e - The click event.
         */
        function handleActionListClick(e) {
            const row = e.target.closest('.action-row');
            if (row) {
                const actionName = row.dataset.actionName;
                // Toggle expansion
                if (uiState.expandedAction === actionName) {
                    uiState.expandedAction = null;
                } else {
                    uiState.expandedAction = actionName;
                }
                // Re-render to reflect the change
                renderActionList();
            }
        }

        /**
         * Handles global key presses for search and navigation.
         */
        function handleGlobalKeyDown(e) {
            const visibleActions = document.querySelectorAll('.action-row');

            // Handle key presses while inside the search input
            if (e.target.tagName === 'INPUT') {
                switch (e.key) {
                    case 'Escape':
                        searchInputEl.value = '';
                        searchInputEl.blur();
                        renderActionList();
                        break;
                    case 'ArrowDown':
                        // NEW: Move focus from search to the list
                        e.preventDefault();
                        if (visibleActions.length > 0) {
                            uiState.selectedActionIndex = 0;
                            searchInputEl.blur(); // Unfocus the search bar
                            renderActionList();
                        }
                        break;
                }
                return; // Stop further execution for input fields
            }

            if (visibleActions.length === 0 && e.key !== '/') return;

            switch (e.key) {
                case '/':
                    e.preventDefault();
                    searchInputEl.focus();
                    break;

                case 'ArrowDown':
                    e.preventDefault();
                    uiState.selectedActionIndex = Math.min(uiState.selectedActionIndex + 1, visibleActions.length - 1);
                    renderActionList();
                    break;

                case 'ArrowUp':
                    e.preventDefault();
                    // Allow moving selection back to -1 (nothing selected)
                    if (uiState.selectedActionIndex > 0) {
                       uiState.selectedActionIndex--;
                    } else {
                       uiState.selectedActionIndex = -1; // Deselect
                       searchInputEl.focus(); // Return focus to search
                    }
                    renderActionList();
                    break;

                case 'Enter':
                case ' ': // Spacebar
                    if (uiState.selectedActionIndex !== -1) {
                        e.preventDefault();
                        const selectedRow = visibleActions[uiState.selectedActionIndex];
                        if (selectedRow) {
                            const actionName = selectedRow.dataset.actionName;
                            uiState.expandedAction = uiState.expandedAction === actionName ? null : actionName;
                            renderActionList();
                        }
                    }
                    break;

                // NEW: Logic for Left and Right arrows
                case 'ArrowRight':
                     if (uiState.selectedActionIndex !== -1) {
                        e.preventDefault();
                        const selectedRow = visibleActions[uiState.selectedActionIndex];
                        if (selectedRow) {
                            const actionName = selectedRow.dataset.actionName;
                            uiState.expandedAction = actionName; // Always expand
                            renderActionList();
                        }
                    }
                    break;

                case 'ArrowLeft':
                     if (uiState.selectedActionIndex !== -1) {
                        e.preventDefault();
                        const selectedRow = visibleActions[uiState.selectedActionIndex];
                        if (selectedRow) {
                            uiState.expandedAction = null; // Always collapse
                            renderActionList();
                        }
                    }
                    break;
            }
        }

        /**
         * Loads character data from localStorage and sets defaults.
         */
        function loadCharacterData() {
            const savedData = localStorage.getItem('insightCharacterData');
            if (savedData) {
                characterData = JSON.parse(savedData);
            } else {
                // NEW: Set default attribute scores to 3 if no data exists
                for (const attribute in characterSchema) {
                    if (attribute !== "Special") { // Don't give "Special" an attribute score
                       characterData[attribute] = 3;
                    }
                }
            }
        }

        /**
         * Initializes the application.
         */
        function init() {
            loadCharacterData();
            renderCharacterSheet();
            renderActionList();

            // --- Event Listeners ---
            characterSheetEl.addEventListener('input', handleCharacterDataChange);
            actionListEl.addEventListener('click', handleActionListClick);
            searchInputEl.addEventListener('input', renderActionList);
            sortOrderEl.addEventListener('change', renderActionList);

            // NEW: Event listener for the toggle button
            const toggleBtn = document.getElementById('toggleCharacterPanel');
            const characterPanel = document.getElementById('characterPanel');
            const actionListPanel = document.getElementById('actionListPanel');

            toggleBtn.addEventListener('click', () => {
                const isHidden = characterPanel.classList.toggle('hidden');
                if (isHidden) {
                    actionListPanel.classList.remove('lg:col-span-2');
                    actionListPanel.classList.add('lg:col-span-3');
                } else {
                    actionListPanel.classList.remove('lg:col-span-3');
                    actionListPanel.classList.add('lg:col-span-2');
                }
            });

            // Add this new line at the end of the init function
            document.addEventListener('keydown', handleGlobalKeyDown);
        }

        const resetBtn = document.getElementById('resetCharacterBtn');
        resetBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to reset all character stats?')) {
                localStorage.removeItem('insightCharacterData');
                characterData = {}; // Clear the in-memory data
                loadCharacterData(); // Reload with defaults
                renderCharacterSheet();
                renderActionList();
            }
        });

        // Start the app
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
