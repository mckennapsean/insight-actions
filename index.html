<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insight Action Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for a better look in dark mode */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        #characterPanel {
            max-height: 85vh; /* 85% of the viewport height */
            overflow-y: auto; /* Add a scrollbar only when needed */
        }
        /* Style for the tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: max-content;
            background-color: #111827;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid #374151;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        /* Simple transition for expanding rows */
        .action-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            display: none;
        }
        .action-row.expanded .action-details {
            max-height: 200px; /* Adjust as needed */
            display: block;
        }
        .action-row.selected {
            border-color: #2563eb; /* A distinct blue border */
            border-width: 2px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans antialiased">

    <div id="app" class="container mx-auto p-4 md:p-6 lg:p-8">

        <header class="mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-4">Insight Action Analyzer</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <input type="text" id="searchInput" placeholder="Search for an action... (e.g., 'sneak', 'intimidate')" class="lg:col-span-2 w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="grid grid-cols-2 md:grid-cols-2 gap-4">
                    <div class="flex items-center">
                         <label for="sortOrder" class="text-sm mr-2">Sort:</label>
                        <select id="sortOrder" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-2 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="best">Best for Me</option>
                            <option value="alpha">Alphabetical</option>
                            <option value="page">Page Number</option>
                        </select>
                    </div>
                    <button id="toggleCharacterPanel" title="Toggle Character Panel" class="flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded-lg p-2 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <main id="mainContainer" class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Column: Character Sheet -->
            <aside id="characterPanel" class="lg:col-span-1 bg-gray-800 p-4 rounded-lg h-fit sticky top-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">My Character</h2>
                    <button id="resetCharacterBtn" class="text-sm text-blue-400 hover:text-blue-300 hover:underline">Reset</button>
                </div>
                <div id="characterSheet">
                    <!-- Character sheet will be dynamically generated here -->
                </div>
            </aside>

            <!-- Right Column: Action List -->
            <section id="actionListPanel" class="lg:col-span-2">
                <div id="actionList" class="space-y-3">
                    <!-- Action items will be dynamically generated here -->
                </div>
            </section>

        </main>
    </div>

    <script>
        // --- DATA ---
        // This section contains all the game data needed for the app.

        const actionsData = [
            // --- NON-COMBAT ACTIONS ---
            { Action: 'Acrobatics Roll', Page: 100, MainSkill: 'Agility (BC)', BonusSkill: 'Balance (BC)', Notes: '', isCombat: false },
            { Action: 'Animal Training', Page: 100, MainSkill: 'Convince (SO)', BonusSkill: 'Creature Insight (RE)', Notes: 'vs. Willpower (Morale + Courage) *', isCombat: false },
            { Action: 'Appraise', Page: 100, MainSkill: 'Idea (RE)', BonusSkill: 'any relevant Item Knowledge (KN)', Notes: '', isCombat: false },
            { Action: 'Appraise, Hunch', Page: 101, MainSkill: 'Idea (RE)', BonusSkill: 'Item Insight (RE)', Notes: '', isCombat: false },
            { Action: 'Autopsy', Page: 108, MainSkill: 'Idea (RE)', BonusSkill: 'Anatomy (KN)', Notes: '', isCombat: false },
            { Action: 'Balance Roll', Page: 108, MainSkill: 'Balance (BC)', BonusSkill: 'Flexibility (PF)', Notes: '', isCombat: false },
            { Action: 'Blend In', Page: 108, MainSkill: 'Perform (SO)', BonusSkill: 'Talk (SO)', Notes: '', isCombat: false },
            { Action: 'Bluff', Page: 109, MainSkill: 'Convince (SO)', BonusSkill: 'Perform (SO)', Notes: 'vs. Sense Motive. See also: Lie.', isCombat: false },
            { Action: 'Breath Holding', Page: 110, MainSkill: 'Endurance (PF)', BonusSkill: 'Calmness (PF)', Notes: '', isCombat: false },
            { Action: 'Butchering', Page: 110, MainSkill: 'Crafting (BC)', BonusSkill: 'Any Melee Weapons Knowledge (KN)', Notes: '', isCombat: false },
            { Action: 'Camouflage Roll, Disguise', Page: 110, MainSkill: 'Camouflage (BC special)', BonusSkill: 'Perform (SO)', Notes: 'See also: Disguise.', isCombat: false },
            { Action: 'Camouflage Roll, Cloaking', Page: 110, MainSkill: 'Camouflage (BC special)', BonusSkill: 'Calmness (SO)', Notes: '', isCombat: false },
            { Action: 'Cant', Page: 110, MainSkill: 'Talk (SO)', BonusSkill: 'Code Insight (SO)', Notes: '(hidden communication)', isCombat: false },
            { Action: 'Climb Roll', Page: 110, MainSkill: 'Mobility (BC)', BonusSkill: 'Balance (BC)', Notes: '', isCombat: false },
            { Action: 'Code Breaking', Page: 111, MainSkill: 'Code Insight (RE)', BonusSkill: 'Idea (RE)', Notes: '', isCombat: false },
            { Action: 'Conceal, on Body', Page: 111, MainSkill: 'Dexterity (BC)', BonusSkill: 'Mobility (BC)', Notes: '', isCombat: false },
            { Action: 'Conceal, in surroundings/tracks', Page: 111, MainSkill: 'Dexterity (BC)', BonusSkill: 'Perception (RE)', Notes: '', isCombat: false },
            { Action: 'Cooking', Page: 112, MainSkill: 'Crafting (BC)', BonusSkill: 'Food (KN)', Notes: '', isCombat: false },
            { Action: 'Crafting, Alchemy', Page: 112, MainSkill: 'Crafting (BC)', BonusSkill: 'Alchemy (KN)', Notes: 'See also: Alchemy Roll.', isCombat: false },
            { Action: 'Crafting, Item', Page: 112, MainSkill: 'Crafting (BC)', BonusSkill: 'any Item Knowledge (KN)', Notes: 'See also: Repair Items.', isCombat: false },
            { Action: 'Crafting, Magic Item', Page: 113, MainSkill: 'Crafting (BC)', BonusSkill: 'any Magic (KN) Skill', Notes: 'REQ. Magic Focus (RE); See also: Magic Items, Use.', isCombat: false },
            { Action: 'Crafting, Poison', Page: 114, MainSkill: 'Crafting (BC)', BonusSkill: 'Poisons (KN)', Notes: '', isCombat: false },
            { Action: 'Crafting, Scroll', Page: 115, MainSkill: 'Crafting (BC)', BonusSkill: 'any Magic (KN) Skill', Notes: 'See also: Scroll Crafting.', isCombat: false },
            { Action: 'Crafting, Weapon', Page: 116, MainSkill: 'Crafting (BC)', BonusSkill: 'Melee Weapons Knowledge (KN)', Notes: 'See also: Repair Weapons.', isCombat: false },
            { Action: 'Crafting, Metal Armor', Page: 116, MainSkill: 'Crafting (BC)', BonusSkill: 'Metal Items Knowledge (KN)', Notes: '', isCombat: false },
            { Action: 'Crafting, Non-metal Armor', Page: 116, MainSkill: 'Crafting (BC)', BonusSkill: 'Cloth Items Knowledge (KN)', Notes: '', isCombat: false },
            { Action: 'Crafts Master Roll', Page: 60, MainSkill: '', BonusSkill: '', Notes: 'See rulebook for details.', isCombat: false },
            { Action: 'Creature Connection Roll', Page: 68, MainSkill: '', BonusSkill: '', Notes: 'See rulebook for details.', isCombat: false },
            { Action: 'Daunt Roll', Page: 116, MainSkill: 'Daunt (ST)', BonusSkill: 'Talk (SO)', Notes: 'vs. Complexity Level (Influence + Self-Insight Roll)', isCombat: true },
            { Action: 'Detect Magic Roll', Page: 118, MainSkill: 'Perception (RE)', BonusSkill: 'Code Insight (RE)', Notes: '', isCombat: false },
            { Action: 'Detect Poison', Page: 119, MainSkill: 'Perception (RE)', BonusSkill: 'Poisons (KN)', Notes: '', isCombat: false },
            { Action: 'Disable Device/Repair Device', Page: 119, MainSkill: 'Dexterity (BC)', BonusSkill: 'Mechanical Devices (KN)', Notes: 'See also: Repair Device.', isCombat: false },
            { Action: 'Divine Chanting', Page: 119, MainSkill: 'Divine Insight (RE)', BonusSkill: 'any Rite (KN)', Notes: '', isCombat: false },
            { Action: 'Emotion Control', Page: 120, MainSkill: 'Perform (SO)', BonusSkill: 'Will (RE)', Notes: '', isCombat: false },
            { Action: 'Empathy Roll', Page: 120, MainSkill: 'Empathy (SO)', BonusSkill: 'Comprehend (RE)', Notes: '', isCombat: false },
            { Action: 'Endurance Roll', Page: 120, MainSkill: 'Endurance (PF)', BonusSkill: 'Will (RE)', Notes: '', isCombat: false },
            { Action: 'Escape Artist', Page: 120, MainSkill: 'Flexibility (PF)', BonusSkill: 'Dexterity (BC)', Notes: '', isCombat: false },
            { Action: 'Fall Roll/Falling', Page: 120, MainSkill: 'Reaction (RE)', BonusSkill: 'Flexibility (PF)', Notes: '', isCombat: false },
            { Action: 'Fascinate', Page: 121, MainSkill: 'Talk (SO)', BonusSkill: 'Relevant Knowledge (KN) Skill', Notes: 'vs. Idea (RE) + the same Knowledge (KN) Skill.', isCombat: false },
            { Action: 'Fire Building', Page: 122, MainSkill: 'Crafting (BC)', BonusSkill: 'Any Wood, Item (KN)', Notes: '', isCombat: false },
            { Action: 'First Aid', Page: 122, MainSkill: 'Medical (KN)', BonusSkill: 'Anatomy (KN)', Notes: 'See also: Heal.', isCombat: false },
            { Action: 'First Aid, Poison', Page: 122, MainSkill: 'Medical (KN)', BonusSkill: 'Poisons (KN)', Notes: '', isCombat: false },
            { Action: 'Forage (Nature)', Page: 122, MainSkill: 'Nature (KN)', BonusSkill: 'Perception (RE)', Notes: 'Forage variant.', isCombat: false },
            { Action: 'Forage (Food)', Page: 122, MainSkill: 'Food (KN)', BonusSkill: 'Perception (RE)', Notes: 'Forage variant.', isCombat: false },
            { Action: 'Health Roll (Constitution)', Page: 123, MainSkill: 'Constitution (PF)', BonusSkill: 'Will (RE)', Notes: 'Health Roll variant.', isCombat: false },
            { Action: 'Health Roll (Toughness)', Page: 123, MainSkill: 'Toughness (ST)', BonusSkill: 'Will (RE)', Notes: 'Health Roll variant.', isCombat: false },
            { Action: 'Hypnotism Roll', Page: 123, MainSkill: 'Hypnosis (RE special)', BonusSkill: 'Comprehend (RE)', Notes: 'vs. Willpower Roll.', isCombat: false },
            { Action: 'Information Gathering, Analytic', Page: 123, MainSkill: 'Idea (RE)', BonusSkill: 'Code Insight (RE)', Notes: '', isCombat: false },
            { Action: 'Information Gathering, Public', Page: 123, MainSkill: 'Idea (RE)', BonusSkill: 'Public (KN)', Notes: '', isCombat: false },
            { Action: 'Information Gathering, Law', Page: 124, MainSkill: 'Idea (RE)', BonusSkill: 'Law (KN)', Notes: '', isCombat: false },
            { Action: 'Interpreter Roll', Page: 125, MainSkill: 'Talk (SO)', BonusSkill: 'Interpreter (KN special)', Notes: '', isCombat: false },
            { Action: 'Interrogation', Page: 125, MainSkill: 'Talk (SO)', BonusSkill: 'Perception (RE)', Notes: 'vs. Willpower.', isCombat: false },
            { Action: 'Intimidation', Page: 125, MainSkill: 'Convince (SO)', BonusSkill: 'Brawn (ST)', Notes: 'vs. Willpower (reduce by Daunt Roll).', isCombat: true },
            { Action: 'Intuition Roll', Page: 126, MainSkill: 'Intuition (RE)', BonusSkill: 'Introspection (RE)', Notes: '', isCombat: false },
            { Action: 'Jump', Page: 126, MainSkill: 'Mobility (BC)', BonusSkill: 'Flexibility (PF)', Notes: '', isCombat: false },
            { Action: 'Law Roll', Page: 126, MainSkill: 'Convince (SO)', BonusSkill: 'Law (KN)', Notes: '', isCombat: false },
            { Action: 'Leadership Roll', Page: 126, MainSkill: 'Leadership (SO)', BonusSkill: 'Talk (SO)', Notes: '', isCombat: false },
            { Action: 'Lock Picking', Page: 127, MainSkill: 'Dexterity (BC)', BonusSkill: 'Mechanical Devices (KN)', Notes: '', isCombat: false },
            { Action: 'Loyalty Roll', Page: 127, MainSkill: 'Enhanced Leadership (SO special)', BonusSkill: 'Motivate (SO special)', Notes: '', isCombat: false },
            { Action: 'Luck Roll', Page: 127, MainSkill: '', BonusSkill: '', Notes: 'Roll 1d10. See rulebook for details.', isCombat: false },
            { Action: 'Magic Spell Casting', Page: 128, MainSkill: 'Magic Insight (RE)', BonusSkill: 'any Magic (KN) skill', Notes: 'Additional details on page 251.', isCombat: false },
            { Action: 'Meditation Roll', Page: 128, MainSkill: 'Serenity (RE)', BonusSkill: 'Calmness (PF)', Notes: '', isCombat: false },
            { Action: 'Morale Boost', Page: 128, MainSkill: 'Motivate (SO special)', BonusSkill: 'Motive Insight (RE)', Notes: '', isCombat: false },
            { Action: 'Motivate/Demotivate', Page: 129, MainSkill: 'Motivate (SO special)', BonusSkill: 'Motive Insight (RE)', Notes: 'vs. Self-Insight Roll.', isCombat: false },
            { Action: 'Navigation', Page: 129, MainSkill: 'Idea (RE)', BonusSkill: 'Nature (KN)', Notes: '', isCombat: false },
            { Action: 'Negotiation', Page: 129, MainSkill: 'Convince (SO)', BonusSkill: 'Idea (RE)', Notes: 'See also: Bargain, Haggle.', isCombat: false },
            { Action: 'Observation', Page: 130, MainSkill: 'Creature Insight (RE)', BonusSkill: 'Perception (RE)', Notes: '', isCombat: false },
            { Action: 'Patience Roll', Page: 130, MainSkill: 'Patience (SO)', BonusSkill: 'Will (RE)', Notes: '(Anger Management)', isCombat: false },
            { Action: 'Perception Roll, Active', Page: 130, MainSkill: 'Perception (RE)', BonusSkill: 'Sense (PF)', Notes: 'See also: Search Roll.', isCombat: false },
            { Action: 'Perception Roll, Passive', Page: 130, MainSkill: 'Sense (PF)', BonusSkill: 'Perception (RE)', Notes: 'See also: Spot Hidden/Secret.', isCombat: false },
            { Action: 'Perform, Instrumental', Page: 131, MainSkill: 'Perform (SO)', BonusSkill: 'any Music Instrument (KN) skill', Notes: 'See also: Play Music Instrument.', isCombat: false },
            { Action: 'Perform, Singing', Page: 132, MainSkill: 'Perform (SO)', BonusSkill: 'Singing (KN)', Notes: 'See also: Singing.', isCombat: false },
            { Action: 'Persuasion', Page: 132, MainSkill: 'Convince (SO)', BonusSkill: 'Motive Insight (RE)', Notes: 'A primary form of Convince.', isCombat: false },
            { Action: 'Pick Pockets', Page: 133, MainSkill: 'Dexterity (BC)', BonusSkill: 'Reaction (RE)', Notes: '(stealing in general). vs. Passive Perception Roll', isCombat: false },
            { Action: 'Precision Roll', Page: 133, MainSkill: 'Precision (BC)', BonusSkill: 'Dexterity (BC)', Notes: '', isCombat: false },
            { Action: 'Psionic Powers', Page: 297, MainSkill: '', BonusSkill: '', Notes: 'See rulebook page 297 for details.', isCombat: false },
            { Action: 'Psychology', Page: 133, MainSkill: 'Idea (RE)', BonusSkill: 'Motive Insight (KN)', Notes: '', isCombat: false },
            { Action: 'Resist Cold', Page: 135, MainSkill: 'Toughness (ST)', BonusSkill: 'Constitution (PF)', Notes: '', isCombat: false },
            { Action: 'Resist Diseases', Page: 135, MainSkill: 'Constitution (PF)', BonusSkill: 'Endurance (PF)', Notes: '', isCombat: false },
            { Action: 'Resist Fire', Page: 135, MainSkill: 'Toughness (ST)', BonusSkill: 'Constitution (PF)', Notes: '', isCombat: false },
            { Action: 'Resist Magic (Constitution)', Page: 135, MainSkill: 'Constitution (PF)', BonusSkill: 'Reaction (RE)', Notes: 'Resist Magic variant.', isCombat: true },
            { Action: 'Resist Magic (Reaction)', Page: 135, MainSkill: 'Reaction (RE)', BonusSkill: 'Constitution (PF)', Notes: 'Resist Magic variant.', isCombat: true },
            { Action: 'Resist Nausea', Page: 135, MainSkill: 'Constitution (PF)', BonusSkill: 'Will (RE)', Notes: '', isCombat: false },
            { Action: 'Resist Pain', Page: 135, MainSkill: 'Constitution (PF)', BonusSkill: 'Will (RE)', Notes: '', isCombat: false },
            { Action: 'Resist Poison', Page: 135, MainSkill: 'Constitution (PF)', BonusSkill: 'Endurance (PF)', Notes: '', isCombat: false },
            { Action: 'Ritual Magic Roll', Page: 252, MainSkill: '', BonusSkill: '', Notes: 'See rulebook page 252 for details.', isCombat: false },
            { Action: 'Rope Use (Crafting)', Page: 137, MainSkill: '', BonusSkill: '', Notes: 'Use any Item Crafting Action, see page 112.', isCombat: false },
            { Action: 'Rope Use (Dexterity/Brawn)', Page: 137, MainSkill: 'Dexterity (BC)', BonusSkill: 'Brawn (ST)', Notes: 'with no Action Improvements.', isCombat: false },
            { Action: 'Rope Use (Dexterity/Flexibility)', Page: 137, MainSkill: 'Dexterity (BC)', BonusSkill: 'Flexibility (PF)', Notes: 'with no Action Improvements.', isCombat: false },
            { Action: 'Rowing', Page: 137, MainSkill: 'Brawn (ST)', BonusSkill: 'Power (PF)', Notes: '', isCombat: false },
            { Action: 'Self-Insight Roll', Page: 137, MainSkill: 'Introspection (BC)', BonusSkill: 'Comprehend (RE)', Notes: 'See also: Introspection Roll.', isCombat: false },
            { Action: 'Seduce', Page: 138, MainSkill: 'Talk (SO)', BonusSkill: 'Appearance (PF)', Notes: '', isCombat: false },
            { Action: 'Sense Intention (creature)', Page: 138, MainSkill: 'Creature Insight (RE)', BonusSkill: 'Comprehend (RE)', Notes: 'See also: Handle Animals.', isCombat: false },
            { Action: 'Sense Motive', Page: 138, MainSkill: 'Motive Insight (RE)', BonusSkill: 'Idea (RE)', Notes: 'vs. Bluff.', isCombat: false },
            { Action: 'Sleight of Hand Roll', Page: 139, MainSkill: 'Sleight of Hand (BC special)', BonusSkill: 'Haste (PF)', Notes: '', isCombat: false },
            { Action: 'Sneak Roll, Hide', Page: 139, MainSkill: 'Agility (BC)', BonusSkill: 'Mobility (BC)', Notes: 'vs. Perception Roll (active or passive). See also: Hide.', isCombat: false },
            { Action: 'Sneak Roll, Exposed Hiding', Page: 139, MainSkill: 'Agility (BC)', BonusSkill: 'Flexibility (PF)', Notes: 'vs. Perception Roll (Active).', isCombat: false },
            { Action: 'Sneak Roll, Move Silent', Page: 139, MainSkill: 'Agility (BC)', BonusSkill: 'Mobility (BC)', Notes: 'vs. Perception Roll (active or passive). See also: Move Silent.', isCombat: false },
            { Action: 'Sneak Roll, Move Silent & Hidden', Page: 140, MainSkill: 'Agility (BC)', BonusSkill: 'Mobility (BC)', Notes: 'vs. Perception Roll (active or passive).', isCombat: false },
            { Action: 'Strength Roll', Page: 141, MainSkill: 'Brawn (ST)', BonusSkill: 'Power (ST)', Notes: 'See also: Lifting.', isCombat: false },
            { Action: 'Study Roll (General)', Page: 142, MainSkill: 'Study (RE special)', BonusSkill: 'relevant knowledge (KN) skill', Notes: '', isCombat: false },
            { Action: 'Study Roll (Weapons and Armor)', Page: 142, MainSkill: 'Study (RE special)', BonusSkill: 'relevant knowledge (KN) skill', Notes: '', isCombat: false },
            { Action: 'Study Roll (Alchemy)', Page: 142, MainSkill: 'Study (RE special)', BonusSkill: 'Alchemy (KN)', Notes: '', isCombat: false },
            { Action: 'Study Roll (People)', Page: 142, MainSkill: 'Study (RE special)', BonusSkill: 'Motive Insight (RE)', Notes: '', isCombat: false },
            { Action: 'Study Roll (Sample)', Page: 142, MainSkill: 'Study (RE special)', BonusSkill: 'Nature (KN)', Notes: '', isCombat: false },
            { Action: 'Surgery Roll', Page: 143, MainSkill: 'Surgery (KN special)', BonusSkill: 'Idea (RE)', Notes: '', isCombat: false },
            { Action: 'Survival', Page: 143, MainSkill: 'Idea (RE)', BonusSkill: 'Nature (KN)', Notes: '', isCombat: false },
            { Action: 'Swim Roll', Page: 143, MainSkill: 'Swimming (BC)', BonusSkill: 'Flexibility (PF)', Notes: '', isCombat: false },
            { Action: 'Terrifying Gaze', Page: 143, MainSkill: 'Terrifying Look (ST special)', BonusSkill: 'Perform (SO)', Notes: '', isCombat: true },
            { Action: 'Throw Roll', Page: 143, MainSkill: 'Dexterity (BC)', BonusSkill: 'Power (PF)', Notes: '', isCombat: true },
            { Action: 'Torture', Page: 144, MainSkill: 'Convince (SO)', BonusSkill: 'Will (RE)', Notes: 'vs. Resist Pain.', isCombat: true },
            { Action: 'Tracking', Page: 144, MainSkill: 'Perception (RE)', BonusSkill: 'Idea (RE)', Notes: '', isCombat: false },
            { Action: 'Understand (General)', Page: 144, MainSkill: 'Idea (RE)', BonusSkill: 'Comprehend (RE)', Notes: 'Primary roll for Understand. Can also use Law or Public Knowledge. See also: Scrutiny.', isCombat: false },
            { Action: 'Understand (Objects)', Page: 145, MainSkill: 'Idea (RE)', BonusSkill: 'Item Insight (RE)', Notes: 'Primary roll for Understand (Objects). Can also use a relevant Knowledge skill.', isCombat: false },
            { Action: 'Understand (Text)', Page: 145, MainSkill: 'Idea (RE)', BonusSkill: 'Languages (KN)', Notes: '', isCombat: false },
            { Action: 'Understand (Creature)', Page: 145, MainSkill: 'Idea (RE)', BonusSkill: 'Creature Insight (RE)', Notes: '', isCombat: false },
            { Action: 'Understand (Riddles)', Page: 145, MainSkill: 'Idea (RE)', BonusSkill: 'Code Insight (RE)', Notes: '', isCombat: false },
            { Action: 'Willpower Roll', Page: 145, MainSkill: 'Will (RE)', BonusSkill: 'Introspection (RE)', Notes: '', isCombat: false },
            { Action: 'Armor Use', Page: 101, MainSkill: 'Mobility (BC)', BonusSkill: 'Flexibility (PF)', Notes: '', isCombat: true },
            { Action: 'Arrow Catching', Page: 101, MainSkill: '', BonusSkill: '', Notes: 'Requires Sleight of Hand Roll. REQ: 2x Success. Complexity Level = attacker’s successes.', isCombat: true },
            { Action: 'Attack, Standard Melee', Page: 102, MainSkill: 'Any Melee (BC)', BonusSkill: 'Melee Weapons Knowledge (KN)', Notes: 'vs. Defense Roll, Dodge Roll, or Block', isCombat: true },
            { Action: 'Attack, Standard Unarmed', Page: 102, MainSkill: 'Unarmed (Small) Melee (BC)', BonusSkill: 'Martial Arts (KN)', Notes: 'vs. Defense Roll, Dodge Roll, or Block', isCombat: true },
            { Action: 'Attack, Acrobatic (Acrobatics)', Page: 102, MainSkill: 'Agility (BC)', BonusSkill: 'Balance (BC)', Notes: 'REQ. Full Attack. Prerequisite roll for the melee attack variant.', isCombat: true },
            { Action: 'Attack, Acrobatic (Melee)', Page: 102, MainSkill: '', BonusSkill: '', Notes: 'Uses (Small/Medium) Melee (BC) + successes from the Acrobatics roll. vs. Defense Roll, Dodge Roll, or Block.', isCombat: true },
            { Action: 'Attack, Blind/Blindfolded', Page: 180, MainSkill: '', BonusSkill: '', Notes: 'See rulebook page 180 for details.', isCombat: true },
            { Action: 'Attack, Bull Rush', Page: 103, MainSkill: 'Unarmed Melee (BC)', BonusSkill: 'Haste (PF)', Notes: 'REQ. Full attack. vs. Defense Roll or Dodge Roll', isCombat: true },
            { Action: 'Attack, Charge', Page: 103, MainSkill: 'Any Melee (BC)', BonusSkill: 'Melee Weapons Knowledge (KN)', Notes: 'REQ. Full Attack, Start 5 tiles from target. vs. Defense Roll, Dodge Roll, or Block.', isCombat: true },
            { Action: 'Attack, Off-Hand', Page: 103, MainSkill: '', BonusSkill: '', Notes: 'Uses a standard attack roll. Success Range is limited by your Ambidextrous Skill. vs. Defense Roll, Dodge Roll, or Block', isCombat: true },
            { Action: 'Attack, Disarm', Page: 104, MainSkill: '', BonusSkill: '', Notes: 'Uses a standard attack roll. REQ. Full Standard Attack Roll, Called Shot, targeting opponents’ weapon. vs. Defense Roll', isCombat: true },
            { Action: 'Attack, Grapple', Page: 104, MainSkill: '(Small &) Unarmed Melee (BC)', BonusSkill: 'Dexterity (BC)', Notes: 'REQ. Full Attack. vs. Grapple Attack, Defense Roll, or Dodge Roll. See also: Grapple.', isCombat: true },
            { Action: 'Attack, Mounted Archery (Riding)', Page: 105, MainSkill: 'Balance (BC)', BonusSkill: 'Mobility (BC)', Notes: 'REQ. Quick or Aimed. Prerequisite for the ranged attack variant.', isCombat: true },
            { Action: 'Attack, Mounted Archery (Ranged)', Page: 105, MainSkill: 'Archery (BC)', BonusSkill: 'Simple Ranged Weapon Knowledge (KN)', Notes: 'REQ. Quick or Aimed. vs. Ranged Defense Roll.', isCombat: true },
            { Action: 'Attack, Mounted Melee (Riding)', Page: 105, MainSkill: 'Balance (BC)', BonusSkill: 'Mobility (BC)', Notes: 'REQ. Full Attack. Prerequisite for the melee attack variant.', isCombat: true },
            { Action: 'Attack, Mounted Melee (Melee)', Page: 105, MainSkill: '', BonusSkill: '', Notes: 'Uses Medium or Large Melee (BC) + successes from the Riding roll. vs. Defense Roll, Dodge Roll, or Block.', isCombat: true },
            { Action: 'Attack, Ranged Bow', Page: 105, MainSkill: 'Archery (BC)', BonusSkill: 'Simple Ranged Weapon Knowledge (KN)', Notes: 'REQ. Quick or Aimed. vs. Defense Roll, Ranged.', isCombat: true },
            { Action: 'Attack, Ranged Crossbow', Page: 105, MainSkill: 'Crossbows (BC)', BonusSkill: 'Mechanical Weapons Knowledge (KN)', Notes: 'REQ. Quick or Aimed. vs. Defense Roll, Ranged.', isCombat: true },
            { Action: 'Attack, Ranged Slings', Page: 106, MainSkill: 'Slings (BC)', BonusSkill: 'Simple Ranged Weapons Knowledge (KN)', Notes: 'REQ. Quick or Aimed. vs. Defense Roll, Ranged.', isCombat: true },
            { Action: 'Attack, Blowguns', Page: 106, MainSkill: 'Blowguns (BC)', BonusSkill: 'Blowguns Knowledge (KN)', Notes: 'REQ. Quick or Aimed. vs. Defense Roll, Ranged.', isCombat: true },
            { Action: 'Attack, Sneak', Page: 106, MainSkill: 'Any Melee (BC)', BonusSkill: 'Melee Weapons Knowledge (KN)', Notes: 'REQ. Full Attack. vs. Defense Roll or Dodge Roll.', isCombat: true },
            { Action: 'Attack, Ranged Sneak', Page: 106, MainSkill: '', BonusSkill: '', Notes: 'Skill Combination same as Ranged Attack. REQ. Aimed. vs. Defense Roll, Ranged.', isCombat: true },
            { Action: 'Attack, Taunt', Page: 106, MainSkill: 'Any Melee (BC)', BonusSkill: 'Talk (SO)', Notes: 'vs. Willpower Roll.', isCombat: true },
            { Action: 'Attack, Thrown Weapon', Page: 107, MainSkill: 'Any Melee (BC)', BonusSkill: 'Melee Weapons Knowledge (KN)', Notes: 'REQ. Full Attack. vs. Defense Roll, Dodge Roll, or Block.', isCombat: true },
            { Action: 'Attack, Trip (Unarmed)', Page: 107, MainSkill: '(Small &) Unarmed Melee (BC)', BonusSkill: 'Martial Arts (KN)', Notes: 'REQ. Full Attack. vs. Defense Roll or Dodge Roll. See Armed variant.', isCombat: true },
            { Action: 'Attack, Trip (Armed)', Page: 107, MainSkill: 'Med/Lrg Melee (BC)', BonusSkill: 'Melee Weapons Knowledge (KN)', Notes: 'REQ. Full Attack. vs. Defense Roll or Dodge Roll. See Unarmed variant.', isCombat: true },
            { Action: 'Attack, Tumble', Page: 107, MainSkill: 'Small & Unarmed Melee (BC)', BonusSkill: 'Quick Dodge (BC special)', Notes: 'REQ. Full Attack.', isCombat: true },
            { Action: 'Block, Arm Block', Page: 109, MainSkill: 'Haste (PF)', BonusSkill: 'Reaction (RE)', Notes: 'alternative to Standard Defense Roll.', isCombat: true },
            { Action: 'Block, Unarmed Block', Page: 109, MainSkill: 'Unarmed Master (BC special)', BonusSkill: 'Ambidextrous (BC)', Notes: 'alternative to Standard Defense Roll.', isCombat: true },
            { Action: 'Block, Shield Block', Page: 109, MainSkill: 'Haste (PF)', BonusSkill: 'Reaction (RE)', Notes: 'alternative to Standard Defense Roll.', isCombat: true },
            { Action: 'Defense Roll, Melee', Page: 117, MainSkill: '', BonusSkill: '', Notes: 'Uses a standard attack roll. Also used for Counterattack Rolls.', isCombat: true },
            { Action: 'Defense Roll, Ranged (Reaction)', Page: 117, MainSkill: 'Reaction (RE)', BonusSkill: 'Perception (RE)', Notes: 'Dodge Projectiles. Prerequisite for the dodge variant.', isCombat: true },
            { Action: 'Defense Roll, Ranged (Dodge)', Page: 117, MainSkill: 'Agility (BC)', BonusSkill: 'Reaction (RE)', Notes: 'Dodge Projectiles. See reaction variant.', isCombat: true },
            { Action: 'Defense Roll, Ranged (Shield Reaction)', Page: 118, MainSkill: 'Reaction (RE)', BonusSkill: 'Perception (RE)', Notes: 'Shield block projectiles. Prerequisite for the shield block variant.', isCombat: true },
            { Action: 'Defense Roll, Ranged (Shield Block)', Page: 118, MainSkill: 'Haste (PF)', BonusSkill: 'Reaction (RE)', Notes: 'Shield block projectiles. See shield reaction variant.', isCombat: true },
            { Action: 'Dodge Roll', Page: 119, MainSkill: 'Agility (BC)', BonusSkill: 'Reaction (RE)', Notes: '', isCombat: true },
            { Action: 'Dodge Roll, Quick', Page: 119, MainSkill: 'Quick Dodge (BC special)', BonusSkill: 'Reaction (RE)', Notes: '', isCombat: true },
            { Action: 'Initiative Adjust Roll', Page: 124, MainSkill: 'Endurance (PF)', BonusSkill: 'Will (RE)', Notes: '', isCombat: true },
            { Action: 'Initiative Roll', Page: 124, MainSkill: 'Any Combat Skill (BC)', BonusSkill: 'Reaction (RE)', Notes: '', isCombat: true }
        ];

        const specializedSkills = new Set([
            'Camouflage', 'Quick Dodge', 'Hypnosis', 'Interpreter', 'Enhanced Leadership',
            'Motivate', 'Logic Recall', 'Sleight of Hand', 'Study', 'Surgery',
            'Terrifying Look', 'Unarmed Master', 'Ambidextrous'
        ]);

        const characterSchema = {
            "Strength (ST)": ["Daunt", "Brawn", "Power", "Toughness", "Terrifying Look"],
            "Physical Fitness (PF)": ["Flexibility", "Calmness", "Endurance", "Haste", "Power", "Constitution", "Sense", "Appearance"],
            "Body Control (BC)": ["Agility", "Balance", "Crafting", "Dexterity", "Mobility", "Precision", "Reaction", "Swimming", "Any Melee", "Unarmed (Small) Melee", "Archery", "Crossbows", "Slings", "Blowguns", "Med/Lrg Melee", "Small & Unarmed Melee", "Introspection", "Any Combat Skill", "Sleight of Hand", "Quick Dodge", "Unarmed Master", "Ambidextrous", "Camouflage"],
            "Reason (RE)": ["Idea", "Code Insight", "Item Insight", "Creature Insight", "Anatomy", "Perception", "Divine Insight", "Reaction", "Comprehend", "Empathy", "Will", "Hypnosis", "Introspection", "Intuition", "Motive Insight", "Logic Recall", "Recall", "Serenity", "Study"],
            "Social (SO)": ["Convince", "Perform", "Talk", "Calmness", "Code Insight", "Empathy", "Leadership", "Patience", "Motivate", "Enhanced Leadership"],
            "Knowledge (KN)": ["Item Knowledge", "Anatomy", "Melee Weapons Knowledge", "Food", "Alchemy", "Magic", "Poisons", "Metal Items Knowledge", "Cloth Items Knowledge", "Mechanical Devices", "Rite", "Wood, Item", "Medical", "Nature", "Public", "Law", "Interpreter", "Music Instrument", "Singing", "Motive Insight", "Languages", "Surgery", "Martial Arts", "Simple Ranged Weapon", "Mechanical Weapons", "Blowguns Knowledge"]
        };

        // UPDATED: New success range table based on user feedback
        const successRangeTable = {
            0: 9, 1: 8, 2: 7, 3: 6
        };

        const synonymDictionary = {
            // --- Meta Categories ---
            'combat': ['attack', 'strike', 'fight', 'block', 'defend', 'dodge', 'parry', 'grapple', 'disarm', 'charge', 'rush', 'initiative', 'armor', 'arrow catching', 'counterattack', 'daunt', 'intimidation', 'gaze', 'throw', 'torture'],

            // --- Social & Influence ---
            'talk': ['speak', 'convince', 'persuade', 'negotiate', 'bluff', 'lie', 'interrogate', 'taunt', 'cant', 'fascinate', 'seduce', 'intimidate', 'daunt', 'leadership', 'motivate', 'perform'],
            'persuade': ['convince', 'negotiate', 'bluff', 'fascinate', 'seduce', 'influence', 'talk'],
            'convince': ['persuade', 'negotiate', 'bluff', 'fascinate', 'seduce', 'influence', 'talk', 'convince'],
            'negotiate': ['bargain', 'haggle', 'convince', 'persuade', 'talk'],
            'bluff': ['lie', 'deceive', 'mislead', 'trick', 'talk'],
            'lie': ['bluff', 'deceive', 'mislead', 'trick'],
            'intimidate': ['daunt', 'threaten', 'scare', 'frighten', 'terrify', 'torture'],
            'daunt': ['intimidate', 'threaten', 'scare', 'frighten', 'terrify'],
            'motivate': ['inspire', 'encourage', 'lead', 'boost morale', 'loyalty'],
            'lead': ['motivate', 'inspire', 'command', 'guide', 'leadership'],
            'perform': ['sing', 'play', 'act', 'dance', 'blend in'],

            // --- Stealth & Deception ---
            'stealth': ['sneak', 'hide', 'conceal', 'camouflage', 'disguise', 'move silent'],
            'sneak': ['stealth', 'hide', 'conceal', 'camouflage', 'disguise', 'move silent'],
            'hide': ['stealth', 'sneak', 'conceal', 'camouflage', 'disguise'],
            'conceal': ['stealth', 'sneak', 'hide', 'camouflage', 'disguise'],
            'disguise': ['camouflage', 'impersonate', 'hide', 'conceal'],
            'pickpocket': ['steal', 'pilfer', 'thieve', 'sleight of hand'],
            'steal': ['pickpocket', 'pilfer', 'thieve'],
            'lockpick': ['disable device', 'open lock'],

            // --- Combat & Physical Action ---
            'attack': ['strike', 'fight', 'assault', 'charge', 'rush', 'grapple', 'trip', 'tumble', 'hit', 'disarm', 'bull rush'],
            'strike': ['attack', 'fight', 'hit'],
            'fight': ['attack', 'strike', 'combat', 'brawl'],
            'block': ['defend', 'parry', 'resist', 'withstand', 'dodge', 'arrow catching'],
            'defend': ['block', 'parry', 'resist', 'withstand', 'dodge', 'guard', 'defense roll'],
            'dodge': ['evade', 'avoid', 'block', 'defend', 'tumble'],
            'throw': ['hurl', 'toss', 'fling'],
            'jump': ['leap', 'bound', 'hop'],
            'climb': ['scale', 'ascend'],
            'swim': ['dive', 'wade'],

            // --- Perception & Investigation ---
            'search': ['find', 'spot', 'perceive', 'observe', 'track', 'detect', 'look', 'investigate', 'examine', 'scrutinize', 'appraise', 'search roll'],
            'find': ['search', 'spot', 'perceive', 'observe', 'track', 'detect', 'locate'],
            'observe': ['watch', 'see', 'spot', 'perceive', 'notice', 'search', 'sense'],
            'detect': ['find', 'notice', 'sense', 'perceive', 'search'],
            'track': ['follow', 'trail', 'hunt', 'pursue', 'survival'],
            'appraise': ['evaluate', 'value', 'assess', 'judge', 'price', 'examine'],
            'study': ['learn', 'research', 'examine', 'analyze', 'investigate', 'recall', 'understand'],
            'understand': ['comprehend', 'decipher', 'interpret', 'grasp', 'fathom', 'riddle', 'code breaking', 'scrutiny'],
            'recall': ['remember', 'recollect', 'know'],
            'sense': ['perceive', 'feel', 'detect', 'intuition', 'empathy', 'sense motive', 'handle animals'],

            // --- Crafting & Creation ---
            'craft': ['make', 'build', 'create', 'repair', 'butcher', 'cook', 'forge', 'construct', 'alchemy', 'poison', 'scroll crafting'],
            'make': ['craft', 'build', 'create', 'repair', 'construct'],
            'repair': ['fix', 'mend', 'restore', 'disable device', 'repair device', 'repair items', 'repair weapons'],
            'fix': ['repair', 'mend', 'restore'],
            'cook': ['butcher', 'prepare food'],

            // --- Endurance & Resistance ---
            'resist': ['endure', 'withstand', 'block', 'defend', 'survive', 'tolerate', 'health', 'willpower'],
            'endure': ['resist', 'withstand', 'survive', 'last', 'tolerate', 'breath holding'],
            'heal': ['first aid', 'medicine', 'surgery', 'restore'],

            // --- Magic & Supernatural ---
            'magic': ['spell', 'chant', 'ritual', 'divine', 'psionic', 'enchant', 'scroll'],
            'spell': ['magic', 'chant', 'ritual', 'incantation']
        };

        // --- APP STATE ---
        let characterData = {};
        let uiState = {
            expandedAction: null,
            selectedActionIndex: -1 // -1 means no action is selected
        };

        // --- UTILITY FUNCTIONS ---

        /**
         * Extracts the attribute code (e.g., 'BC') from a skill string.
         * This version correctly handles 'special' tags like (RE special).
         * @param {string} skill - The full skill string, e.g., "Agility (BC)" or "Study (RE special)".
         * @returns {string|null} The attribute code or null if not found.
         */
        function getAttributeFromSkill(skill) {
            // This regex looks for a two-letter uppercase code inside parentheses,
            // optionally followed by the word "special". It only captures the two-letter code.
            const match = skill.match(/\(([A-Z]{2})(?: special)?\)/);
            return match ? match[1] : null;
        }

        /**
         * Finds the full attribute name (e.g., "Body Control (BC)") from its abbreviation.
         * @param {string} abbr - The attribute abbreviation (e.g., "BC").
         * @returns {string|null} The full attribute name or null.
         */
        function getFullAttributeName(abbr) {
            if (!abbr) return null;
            for (const fullName in characterSchema) {
                if (getAttributeFromSkill(fullName) === abbr) {
                    return fullName;
                }
            }
            return null;
        }

        /**
         * Gets a value from the character data, defaulting to 0.
         * @param {string} key - The key for the data (e.g., "Agility" or "Body Control (BC)").
         * @returns {number} The stored value or 0.
         */
        function getCharValue(key) {
            return parseInt(characterData[key] || '0', 10);
        }

        // --- DOM & RENDERING ---
        const characterSheetEl = document.getElementById('characterSheet');
        const actionListEl = document.getElementById('actionList');
        const searchInputEl = document.getElementById('searchInput');
        const sortOrderEl = document.getElementById('sortOrder');

        /**
         * Generates the HTML for the character sheet based on the schema.
         */
        function renderCharacterSheet() {
            let html = '';
            for (const attribute in characterSchema) {
                html += `
                    <details class="bg-gray-700/50 rounded-lg mb-3">
                        <summary class="font-bold text-lg cursor-pointer p-3 flex justify-between items-center">
                            <span>${attribute}</span>
                            <div class="flex items-center" onclick="event.stopPropagation()">
                                <label class="text-sm font-semibold mr-2">Score:</label>
                                <input type="number" min="0" data-type="attribute" data-key="${attribute}" value="${getCharValue(attribute)}" class="w-16 bg-gray-800 border border-gray-600 rounded px-2 py-1">
                            </div>
                        </summary>
                        <div class="p-3 border-t border-gray-600">
                `;

                const sortedSkills = [...characterSchema[attribute]].sort();

                sortedSkills.forEach(skill => {
                    const isSpecial = specializedSkills.has(skill);
                    const skillDisplayName = isSpecial ? `${skill} (special)` : skill;

                    html += `
                        <div class="grid grid-cols-5 gap-2 items-center mb-1">
                            <label class="col-span-3 text-sm ${isSpecial ? 'text-blue-300' : ''}">${skillDisplayName}:</label>
                            <input type="number" min="0" data-type="skill" data-key="${skill}" value="${getCharValue(skill)}" class="col-span-2 bg-gray-800 border border-gray-600 rounded px-2 py-1">
                        </div>
                    `;
                });
                html += `</div></details>`;
            }
            characterSheetEl.innerHTML = html;
        }

        /**
         * Renders the entire list of actions based on current filters and sorting.
         */
        function renderActionList() {
            const searchTerm = searchInputEl.value.toLowerCase().trim();
            const sortBy = sortOrderEl.value;

            let searchTerms = [searchTerm];
            if (synonymDictionary[searchTerm]) {
                searchTerms = [searchTerm, ...synonymDictionary[searchTerm]];
            }

            const filteredActions = actionsData.filter(action => {
                if (!searchTerm) return true;

                if (searchTerm === 'combat' && action.isCombat) {
                    return true;
                }

                const actionText = (action.Action + ' ' + action.Notes).toLowerCase();
                return searchTerms.some(term => actionText.includes(term));
            });

            const actionsWithMetrics = filteredActions.map(action => {
                // Return a default structure for actions without skills
                if (!action.MainSkill) {
                    return { ...action, metrics: { isRollable: false } };
                }

                const mainSkill = action.MainSkill;
                const bonusSkill = action.BonusSkill;
                const mainSkillName = mainSkill.split(' (')[0];
                let bonusSkillName = bonusSkill.split(' (')[0];

                const isBonusSkillVariable = bonusSkill.toLowerCase().includes('any');
                if (isBonusSkillVariable) {
                    bonusSkillName = 'Relevant Knowledge';
                }

                const mainSkillAttrAbbr = getAttributeFromSkill(mainSkill);
                const fullMainSkillAttr = getFullAttributeName(mainSkillAttrAbbr);
                const primarySkillRank = getCharValue(mainSkillName);
                const secondarySkillRank = isBonusSkillVariable ? 0 : getCharValue(bonusSkillName);
                const attributeScore = getCharValue(fullMainSkillAttr);
                const dicePool = attributeScore + secondarySkillRank;

                let successThreshold;
                if (primarySkillRank === 0 && mainSkillAttrAbbr === 'KN') {
                    successThreshold = 10;
                } else {
                    successThreshold = successRangeTable[primarySkillRank] || 11;
                }

                const singleDieSuccessChance = Math.max(0, (11 - successThreshold) / 10);
                const avgSuccesses = dicePool * singleDieSuccessChance;

                return {
                    ...action,
                    metrics: { isRollable: true, dicePool, avgSuccesses, mainSkillName, bonusSkillName, fullMainSkillAttr, primarySkillRank, secondarySkillRank, attributeScore, successThreshold, isBonusSkillVariable }
                };
            });

            actionsWithMetrics.sort((a, b) => {
                if (sortBy === 'best') {
                    // Handle non-rollable actions by pushing them to the bottom
                    const aValue = a.metrics.isRollable ? a.metrics.avgSuccesses : -1;
                    const bValue = b.metrics.isRollable ? b.metrics.avgSuccesses : -1;
                    return bValue - aValue;
                }
                if (sortBy === 'alpha') return a.Action.localeCompare(b.Action);
                if (sortBy === 'page') return (a.Page || 999) - (b.Page || 999);
                return 0;
            });

            if (actionsWithMetrics.length === 0) {
                actionListEl.innerHTML = `<div class="bg-gray-800 p-4 rounded-lg text-center">No actions found.</div>`;
                return;
            }

            actionListEl.innerHTML = actionsWithMetrics.map((action, index) => generateActionRowHTML(action, index)).join('');

            if (uiState.selectedActionIndex !== -1) {
                const selectedElement = document.getElementById(`action-row-${uiState.selectedActionIndex}`);
                if (selectedElement) {
                    selectedElement.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
            }
        }

        /**
         * Generates the HTML for a single action row.
         */
        function generateActionRowHTML(action, index) {
            const isSelected = uiState.selectedActionIndex === index;
            const isExpanded = uiState.expandedAction === action.Action;

            let headerRightHTML = '';
            let detailsHTML = `<p><strong class="text-gray-300">Notes:</strong> ${action.Notes || 'None'}</p>`;
            let skillLineHTML = '';

            if (action.metrics.isRollable) {
                const { metrics } = action;
                const simplifiedMain = metrics.mainSkillName.replace(/\(.*\)/, '').trim();
                const simplifiedBonus = metrics.bonusSkillName.replace(/\(.*\)/, '').trim();
                const bonusSkillDisplay = `${simplifiedBonus}${metrics.isBonusSkillVariable ? ' *' : ''}`;

                headerRightHTML = `
                    <p class="font-semibold text-white">Dice Pool: ${metrics.dicePool}d10</p>
                    <p class="text-sm text-gray-400">
                        Success: ${metrics.successThreshold}+ (Avg: ${metrics.avgSuccesses.toFixed(2)})
                    </p>`;

                skillLineHTML = `
                    <div class="tooltip">
                        <p class="text-sm text-gray-400">${simplifiedMain} + ${bonusSkillDisplay}</p>
                        <span class="tooltiptext">${action.MainSkill} + ${action.BonusSkill}${metrics.isBonusSkillVariable ? ' (Using Rank 0)' : ''}</span>
                    </div>`;

                detailsHTML += `
                    <p class="mt-2"><strong class="text-gray-300">Page:</strong> ${action.Page || 'N/A'}</p>
                    <p class="mt-2 text-blue-300"><strong class="text-gray-300">Calculation:</strong>
                        ${metrics.attributeScore}d10 (from ${metrics.fullMainSkillAttr}) +
                        ${metrics.secondarySkillRank}d10 (from ${metrics.bonusSkillName})
                    </p>
                    <p class="text-blue-300"><strong class="text-gray-300">Success on:</strong>
                        ${metrics.successThreshold}+ (from ${metrics.mainSkillName} rank ${metrics.primarySkillRank})
                    </p>`;
            } else {
                 headerRightHTML = `<p class="text-sm text-gray-400 font-style: italic">Non-Rollable</p>`;
            }

            return `
                <div class="action-row bg-gray-800 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-700/80 ${isExpanded ? 'expanded' : ''} ${isSelected ? 'selected' : ''}" data-action-name="${action.Action}" id="action-row-${index}">
                    <div class="p-4">
                        <div class="grid grid-cols-2 gap-x-4">
                            <div>
                                <h3 class="font-bold text-lg text-white">${action.Action}</h3>
                                ${skillLineHTML}
                            </div>
                            <div class="text-right">
                                ${headerRightHTML}
                            </div>
                        </div>
                        <div class="action-details mt-4 pt-4 border-t border-gray-700 text-sm">
                            ${detailsHTML}
                        </div>
                    </div>
                </div>
            `;
        }


        // --- EVENT HANDLERS & INITIALIZATION ---

        /**
         * Handles input changes on the character sheet.
         * @param {Event} e - The input event.
         */
        function handleCharacterDataChange(e) {
            if (e.target.matches('input[type="number"]')) {
                const key = e.target.dataset.key;
                const value = e.target.value;
                characterData[key] = value;
                localStorage.setItem('insightCharacterData', JSON.stringify(characterData));
                renderActionList();
            }
        }

        /**
         * Handles clicks on the action list to expand/collapse rows.
         * @param {Event} e - The click event.
         */
        function handleActionListClick(e) {
            const row = e.target.closest('.action-row');
            if (row) {
                const actionName = row.dataset.actionName;
                // Toggle expansion
                if (uiState.expandedAction === actionName) {
                    uiState.expandedAction = null;
                } else {
                    uiState.expandedAction = actionName;
                }
                // Re-render to reflect the change
                renderActionList();
            }
        }

        /**
         * Handles global key presses for search and navigation.
         */
        function handleGlobalKeyDown(e) {
            const visibleActions = document.querySelectorAll('.action-row');

            // Handle key presses while inside the search input
            if (e.target.tagName === 'INPUT') {
                switch (e.key) {
                    case 'Escape':
                        searchInputEl.value = '';
                        searchInputEl.blur();
                        renderActionList();
                        break;
                    case 'ArrowDown':
                        // NEW: Move focus from search to the list
                        e.preventDefault();
                        if (visibleActions.length > 0) {
                            uiState.selectedActionIndex = 0;
                            searchInputEl.blur(); // Unfocus the search bar
                            renderActionList();
                        }
                        break;
                }
                return; // Stop further execution for input fields
            }

            if (visibleActions.length === 0 && e.key !== '/') return;

            switch (e.key) {
                case '/':
                    e.preventDefault();
                    searchInputEl.focus();
                    break;

                case 'ArrowDown':
                    e.preventDefault();
                    uiState.selectedActionIndex = Math.min(uiState.selectedActionIndex + 1, visibleActions.length - 1);
                    renderActionList();
                    break;

                case 'ArrowUp':
                    e.preventDefault();
                    // Allow moving selection back to -1 (nothing selected)
                    if (uiState.selectedActionIndex > 0) {
                       uiState.selectedActionIndex--;
                    } else {
                       uiState.selectedActionIndex = -1; // Deselect
                       searchInputEl.focus(); // Return focus to search
                    }
                    renderActionList();
                    break;

                case 'Enter':
                case ' ': // Spacebar
                    if (uiState.selectedActionIndex !== -1) {
                        e.preventDefault();
                        const selectedRow = visibleActions[uiState.selectedActionIndex];
                        if (selectedRow) {
                            const actionName = selectedRow.dataset.actionName;
                            uiState.expandedAction = uiState.expandedAction === actionName ? null : actionName;
                            renderActionList();
                        }
                    }
                    break;

                // NEW: Logic for Left and Right arrows
                case 'ArrowRight':
                     if (uiState.selectedActionIndex !== -1) {
                        e.preventDefault();
                        const selectedRow = visibleActions[uiState.selectedActionIndex];
                        if (selectedRow) {
                            const actionName = selectedRow.dataset.actionName;
                            uiState.expandedAction = actionName; // Always expand
                            renderActionList();
                        }
                    }
                    break;

                case 'ArrowLeft':
                     if (uiState.selectedActionIndex !== -1) {
                        e.preventDefault();
                        const selectedRow = visibleActions[uiState.selectedActionIndex];
                        if (selectedRow) {
                            uiState.expandedAction = null; // Always collapse
                            renderActionList();
                        }
                    }
                    break;
            }
        }

        /**
         * Loads character data from localStorage and sets defaults.
         */
        function loadCharacterData() {
            const savedData = localStorage.getItem('insightCharacterData');
            if (savedData) {
                characterData = JSON.parse(savedData);
            } else {
                // NEW: Set default attribute scores to 3 if no data exists
                for (const attribute in characterSchema) {
                    if (attribute !== "Special") { // Don't give "Special" an attribute score
                       characterData[attribute] = 3;
                    }
                }
            }
        }

        /**
         * Initializes the application.
         */
        function init() {
            loadCharacterData();
            renderCharacterSheet();
            renderActionList();

            // --- Event Listeners ---
            characterSheetEl.addEventListener('input', handleCharacterDataChange);
            actionListEl.addEventListener('click', handleActionListClick);
            searchInputEl.addEventListener('input', renderActionList);
            sortOrderEl.addEventListener('change', renderActionList);

            // NEW: Event listener for the toggle button
            const toggleBtn = document.getElementById('toggleCharacterPanel');
            const characterPanel = document.getElementById('characterPanel');
            const actionListPanel = document.getElementById('actionListPanel');

            toggleBtn.addEventListener('click', () => {
                const isHidden = characterPanel.classList.toggle('hidden');
                if (isHidden) {
                    actionListPanel.classList.remove('lg:col-span-2');
                    actionListPanel.classList.add('lg:col-span-3');
                } else {
                    actionListPanel.classList.remove('lg:col-span-3');
                    actionListPanel.classList.add('lg:col-span-2');
                }
            });

            // Add this new line at the end of the init function
            document.addEventListener('keydown', handleGlobalKeyDown);
        }

        const resetBtn = document.getElementById('resetCharacterBtn');
        resetBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to reset all character stats?')) {
                localStorage.removeItem('insightCharacterData');
                characterData = {}; // Clear the in-memory data
                loadCharacterData(); // Reload with defaults
                renderCharacterSheet();
                renderActionList();
            }
        });

        // Start the app
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
